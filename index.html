<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Sunday">
    <meta name="theme-color" content="#000000">
    <title>Sunday V10.1 Pro</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        :root {
            /* ğŸ”´ V10 Pro æ ¸å¿ƒé…è‰² (Apple OLED Black) */
            --bg-primary: #000000;
            --bg-secondary: #1c1c1e;
            --bg-tertiary: #2c2c2e;
            
            --accent-blue: #0A84FF;
            --accent-teal: #64D2FF;
            --accent-green: #30D158;
            --accent-red: #FF453A;
            --accent-orange: #FF9F0A;
            
            --text-primary: #FFFFFF;
            --text-secondary: rgba(255,255,255,0.6);
            --text-tertiary: rgba(255,255,255,0.4);
            
            --radius-md: 14px;
            --radius-lg: 20px;
            --radius-xl: 26px;
        }

        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', system-ui, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            padding-bottom: 50px; /* åº•éƒ¨ç•™ç™½ */
        }

        /* é¡¶éƒ¨ç¯å¢ƒå…‰æ•ˆ (æ¨¡æ‹Ÿæˆªå›¾å·¦ä¸Šè§’çš„è“è‰²å…‰æ™•) */
        .ambient-light {
            position: fixed; top: -120px; left: -120px; width: 350px; height: 350px;
            background: radial-gradient(circle, rgba(10,132,255,0.12) 0%, transparent 70%);
            z-index: -1; pointer-events: none;
        }

        .app { max-width: 440px; margin: 0 auto; padding: 0 16px; }

        /* Header (é¡¶éƒ¨æ ) */
        .header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 16px 0 20px;
        }
        .logo-area { display: flex; align-items: center; gap: 12px; }
        .logo-icon {
            width: 44px; height: 44px;
            background: linear-gradient(135deg, #0A84FF, #5AC8FA);
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 15px rgba(10,132,255,0.3);
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .logo-text h1 { font-size: 22px; font-weight: 700; letter-spacing: -0.5px; line-height: 1.1; }
        .logo-text span { font-size: 11px; color: var(--text-tertiary); letter-spacing: 0.5px; text-transform: uppercase; font-weight: 500; }
        
        .header-time { text-align: right; }
        .header-time .time { font-size: 26px; font-weight: 700; color: var(--accent-blue); line-height: 1; font-variant-numeric: tabular-nums; }
        .header-time .date { font-size: 11px; color: var(--text-tertiary); margin-top: 4px; }

        /* Navigation (èƒ¶å›Šå¯¼èˆª) */
        .nav {
            display: flex; gap: 6px; padding: 4px;
            background: var(--bg-secondary);
            border-radius: 16px;
            margin-bottom: 24px;
            overflow-x: auto;
            scrollbar-width: none;
        }
        .nav::-webkit-scrollbar { display: none; }
        .nav-btn {
            flex: 1; min-width: 65px; padding: 10px 0;
            border: none; background: transparent;
            color: var(--text-secondary);
            font-family: inherit; font-size: 11px; font-weight: 500;
            border-radius: 12px; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            transition: all 0.2s;
        }
        .nav-btn.active { background: var(--accent-blue); color: white; box-shadow: 0 4px 12px rgba(10,132,255,0.3); }
        .nav-btn .icon { font-size: 20px; margin-bottom: 2px; }

        /* Pages (é¡µé¢åˆ‡æ¢) */
        .page { display: none; animation: fadeIn 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

        /* --- V10 ç»„ä»¶æ ·å¼ --- */

        /* 1. çŠ¶æ€æ–¹å— (Stats Grid) */
        .stats-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px;
        }
        .stat-box {
            background: var(--bg-secondary);
            aspect-ratio: 1;
            border-radius: var(--radius-lg);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 8px;
        }
        .stat-val { font-size: 20px; font-weight: 700; color: var(--accent-blue); margin-bottom: 2px; }
        .stat-lbl { font-size: 11px; color: var(--text-secondary); }

        /* 2. ğŸ’§ å–æ°´å¡ç‰‡ (Hydration Card - é‡ç‚¹) */
        .hydration-card {
            background: linear-gradient(180deg, rgba(10,132,255,0.08) 0%, rgba(28,28,30,0) 100%), var(--bg-secondary);
            border: 1px solid rgba(10,132,255,0.15);
            border-radius: var(--radius-xl);
            padding: 20px;
            margin-bottom: 16px;
        }
        .hyd-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .hyd-title { font-size: 17px; font-weight: 600; display: flex; align-items: center; gap: 8px; color: white; }
        .hyd-count { font-size: 30px; font-weight: 700; color: white; display: flex; align-items: baseline; gap: 4px; }
        .hyd-count span { font-size: 15px; color: var(--text-tertiary); font-weight: 500; }
        
        .hyd-progress-bg { height: 10px; background: rgba(255,255,255,0.1); border-radius: 100px; overflow: hidden; margin-bottom: 20px; }
        .hyd-progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent-blue), var(--accent-teal)); width: 0%; transition: width 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); border-radius: 100px; }
        
        .hyd-btn-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .hyd-btn {
            background: var(--bg-tertiary); border: 1px solid rgba(255,255,255,0.05);
            padding: 14px 0; border-radius: var(--radius-md);
            color: white; font-weight: 600; font-size: 13px; cursor: pointer;
            transition: transform 0.1s;
        }
        .hyd-btn:active { transform: scale(0.96); background: var(--text-secondary); }

        /* é€šç”¨å¡ç‰‡ */
        .card {
            background: var(--bg-secondary);
            border-radius: var(--radius-xl);
            padding: 20px;
            margin-bottom: 16px;
        }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .card-title { font-size: 17px; font-weight: 600; color: white; display: flex; align-items: center; gap: 8px; }

        /* å¤©æ°”å¡ç‰‡ */
        .badge-live { background: rgba(255,69,58,0.15); color: var(--accent-red); font-size: 11px; padding: 5px 10px; border-radius: 100px; font-weight: 700; display: flex; align-items: center; gap: 6px; }
        .badge-live::before { content:''; width:6px; height:6px; background:currentColor; border-radius:50%; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
        
        .weather-main { display: flex; align-items: center; gap: 16px; }
        .weather-big-icon { font-size: 48px; }
        .weather-big-temp { font-size: 44px; font-weight: 700; letter-spacing: -1px; }
        .weather-sub { font-size: 15px; color: var(--text-secondary); margin-top: 2px; }

        /* è¾“å…¥æ¡†ä¸æŒ‰é’® */
        .input-field { width: 100%; padding: 16px; background: var(--bg-tertiary); border: 1px solid rgba(255,255,255,0.05); border-radius: var(--radius-md); color: white; font-size: 16px; margin-bottom: 12px; font-family: inherit; }
        .input-field:focus { outline: none; border-color: var(--accent-blue); }
        
        .btn-full { width: 100%; padding: 16px; border-radius: var(--radius-md); border: none; font-weight: 600; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-blue { background: var(--accent-blue); color: white; }
        .btn-green { background: var(--accent-green); color: black; }
        .btn-red { background: var(--accent-red); color: white; }

        /* åœ°å›¾ */
        .map-box { width: 100%; height: 220px; border-radius: var(--radius-lg); overflow: hidden; background: var(--bg-tertiary); position: relative; margin-bottom: 16px; }
        
        /* åˆ—è¡¨é¡¹ */
        .list-item { display: flex; align-items: center; padding: 16px; background: var(--bg-tertiary); border-radius: var(--radius-md); margin-bottom: 8px; justify-content: space-between; }
        .list-item-sub { font-size: 12px; color: var(--text-tertiary); margin-top: 2px; }
        
        /* Toast æç¤º */
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-150%); background: rgba(28,28,30,0.95); backdrop-filter: blur(20px); padding: 14px 24px; border-radius: 50px; display: flex; align-items: center; gap: 12px; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 9999; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1); width: max-content; }
        .toast.show { transform: translateX(-50%) translateY(0); }
        .toast-icon { font-size: 20px; }
        .toast-msg { font-size: 15px; font-weight: 500; }
    </style>
</head>
<body>

<div class="ambient-light"></div>

<div class="app">
    <header class="header">
        <div class="logo-area">
            <div class="logo-icon">â˜€ï¸</div>
            <div class="logo-text"><h1>Sunday</h1><span>PERSONAL ASSISTANT</span></div>
        </div>
        <div class="header-time">
            <div class="time" id="clockTime">00:00</div>
            <div class="date" id="clockDate">Loading...</div>
        </div>
    </header>

    <nav class="nav">
        <button class="nav-btn active" onclick="switchPage('home', this)"><span class="icon">ğŸ </span>Home</button>
        <button class="nav-btn" onclick="switchPage('life', this)"><span class="icon">ğŸ’«</span>Life</button>
        <button class="nav-btn" onclick="switchPage('weather', this)"><span class="icon">ğŸŒ¤ï¸</span>Weather</button>
        <button class="nav-btn" onclick="switchPage('journey', this)"><span class="icon">ğŸ—ºï¸</span>Journey</button>
        <button class="nav-btn" onclick="switchPage('parking', this)"><span class="icon">ğŸ…¿ï¸</span>Parking</button>
        <button class="nav-btn" onclick="switchPage('tools', this)"><span class="icon">ğŸ› ï¸</span>Tools</button>
    </nav>

    <div id="page-home" class="page active">
        
        <div class="stats-grid">
            <div class="stat-box">
                <div class="stat-val" id="dashTemp">--Â°</div>
                <div class="stat-lbl">Temp</div>
            </div>
            <div class="stat-box">
                <div class="stat-val" id="dashAlerts">0</div>
                <div class="stat-lbl">Alerts</div>
            </div>
            <div class="stat-box">
                <div class="stat-val" id="dashJourneys">0</div>
                <div class="stat-lbl">Journeys</div>
            </div>
            <div class="stat-box">
                <div class="stat-val" id="dashReminders">0</div>
                <div class="stat-lbl">Reminders</div>
            </div>
        </div>

        <div class="hydration-card">
            <div class="hyd-header">
                <div class="hyd-title">ğŸ’§ Hydration</div>
                <div class="hyd-count"><span id="waterVal">0</span><span>/ 8</span></div>
            </div>
            <div class="hyd-progress-bg">
                <div class="hyd-progress-fill" id="waterBar"></div>
            </div>
            <div class="hyd-btn-row">
                <button class="hyd-btn" onclick="modWater(1)">+1 Cup</button>
                <button class="hyd-btn" onclick="modWater(2)">+2 Cups</button>
                <button class="hyd-btn" onclick="modWater(0)">Reset</button>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-title">ğŸŒ¤ï¸ Weather</div>
                <div class="badge-live">LIVE</div>
            </div>
            <div class="weather-main" id="dashWeather">
                <div class="weather-big-icon">â˜€ï¸</div>
                <div>
                    <div class="weather-big-temp">--Â°C</div>
                    <div class="weather-sub">Loading location...</div>
                </div>
            </div>
        </div>
        
        <div class="card">
             <div class="card-title" style="margin-bottom:12px">ğŸ“° Latest News</div>
             <div id="news-feed" style="font-size:13px;color:var(--text-secondary)">
                 <div class="list-item" style="padding:10px;margin:0">Loading news...</div>
             </div>
        </div>
    </div>

    <div id="page-journey" class="page">
        <div class="card" id="journey-active" style="display:none; border: 1px solid var(--accent-green);">
            <div class="card-header">
                <div class="card-title" style="color:var(--accent-green)">ğŸš— Tracking Active</div>
                <div class="badge-live" style="background:rgba(48,209,88,0.2);color:#30D158">REC</div>
            </div>
            <div class="stats-grid" style="grid-template-columns:1fr 1fr 1fr; margin-bottom:16px">
                <div class="stat-box"><div class="stat-val" id="jDist">0.0</div><div class="stat-lbl">km</div></div>
                <div class="stat-box"><div class="stat-val" id="jSpeed">0</div><div class="stat-lbl">km/h</div></div>
                <div class="stat-box"><div class="stat-val" id="jTime">0</div><div class="stat-lbl">min</div></div>
            </div>
            <div class="map-box" id="map-small"></div>
            <button class="btn-full btn-red" onclick="stopJourney()">End Journey ğŸ</button>
        </div>

        <div class="card" id="journey-start">
            <div class="card-title" style="margin-bottom:16px">ğŸš€ New Journey</div>
            <div style="text-align:center; padding:20px 0; color:var(--text-tertiary); font-size:13px">
                GPS Tracking â€¢ Auto Speed Detection â€¢ Calorie Counter
            </div>
            <button class="btn-full btn-blue" onclick="startJourney()">Start Tracking</button>
        </div>

        <div class="card">
            <div class="card-title" style="margin-bottom:12px">ğŸ“œ History</div>
            <div id="journey-list"></div>
        </div>
    </div>

    <div id="page-parking" class="page">
        <div class="card">
            <div class="card-header"><div class="card-title">ğŸš— My Car</div></div>
            
            <div id="park-display" style="text-align:center; padding:30px 20px; color:var(--text-tertiary); border:1px dashed var(--separator); border-radius:var(--radius-md); margin-bottom:20px;">
                No location saved
            </div>
            
            <div class="hyd-btn-row">
                <button class="hyd-btn" onclick="savePark('gps')">ğŸ“ GPS Only</button>
                <button class="hyd-btn" onclick="document.getElementById('cam').click()">ğŸ“¸ Photo</button>
                <button class="hyd-btn" style="background:var(--accent-blue)" onclick="savePark('both')">ğŸ“+ğŸ“¸ Both</button>
            </div>
            <input type="file" id="cam" accept="image/*" style="display:none" onchange="handlePhoto(event)">
        </div>
    </div>
    
    <div id="page-weather" class="page">
        <div class="card">
             <div class="card-title" style="margin-bottom:10px">ğŸŒ Global Search</div>
             <input type="text" class="input-field" id="citySearch" placeholder="Enter city name (e.g. Tokyo)..." onchange="getWeather(this.value)">
             <button class="btn-full btn-blue" onclick="getWeather(document.getElementById('citySearch').value)">Search</button>
             
             <div style="margin-top:20px; text-align:center">
                 <div class="weather-big-icon" id="w-icon">â˜€ï¸</div>
                 <div class="weather-big-temp" id="w-temp">--Â°</div>
                 <div class="weather-sub" id="w-desc">Search for a city</div>
             </div>
        </div>
    </div>
    
    <div id="page-tools" class="page">
        <div class="card">
            <div class="card-title" style="margin-bottom:16px">â° Quick Reminders</div>
            <input type="text" id="rem-txt" class="input-field" placeholder="Remind me to...">
            <div class="hyd-btn-row">
                <button class="hyd-btn" onclick="addRem(10)">+10m</button>
                <button class="hyd-btn" onclick="addRem(30)">+30m</button>
                <button class="hyd-btn" onclick="addRem(60)">+1h</button>
            </div>
            <div id="rem-list" style="margin-top:16px"></div>
        </div>
        
        <div class="card">
            <div class="card-title" style="margin-bottom:10px">ğŸ’± Exchange Rates (MYR)</div>
            <div id="rate-list">
                <div class="list-item">Loading rates...</div>
            </div>
        </div>
    </div>

    <div id="page-life" class="page">
        <div class="card">
            <div class="card-title">ğŸ¯ Focus Timer</div>
            <div style="font-size:50px; font-weight:700; text-align:center; padding:20px 0; font-variant-numeric: tabular-nums;">25:00</div>
            <button class="btn-full btn-blue">Start Focus</button>
        </div>
        <div class="card">
            <div class="card-title">ğŸ˜´ Sleep Log</div>
            <div class="hyd-btn-row" style="margin-top:16px">
                <input type="time" class="input-field" value="23:00" style="margin:0">
                <input type="time" class="input-field" value="07:00" style="margin:0">
                <button class="hyd-btn" style="background:var(--accent-teal)">Log</button>
            </div>
        </div>
    </div>

</div>

<div class="toast" id="toast">
    <span class="toast-icon">âœ…</span>
    <span class="toast-msg" id="toast-msg">Success</span>
</div>

<script>
// --- æ ¸å¿ƒæ•°æ® ---
const APP = {
    water: 0,
    journey: null,
    history: JSON.parse(localStorage.getItem('sun_hist')||'[]'),
    parking: JSON.parse(localStorage.getItem('sun_park')||'null'),
    reminders: JSON.parse(localStorage.getItem('sun_rems')||'[]'),
    map: null,
    watchId: null,
    pendingGPS: null
};

// --- åˆå§‹åŒ– ---
document.addEventListener('DOMContentLoaded', () => {
    updateClock(); setInterval(updateClock, 1000);
    
    // åŠ è½½æ•°æ®
    APP.water = parseInt(localStorage.getItem('sun_water') || '0');
    // æ¯æ—¥é‡ç½®å–æ°´æ•°æ®
    const lastDate = localStorage.getItem('sun_date');
    const today = new Date().toDateString();
    if(lastDate !== today) { APP.water = 0; localStorage.setItem('sun_date', today); }
    
    // æ¸²æŸ“ç•Œé¢
    updateWaterUI();
    updateHistoryUI();
    updateParkingUI();
    updateRemindersUI();
    getWeather('Johor Jaya'); // é»˜è®¤ä½ç½®
    getRates();
    getNews();
    
    // æ£€æŸ¥æé†’
    setInterval(checkReminders, 10000);
    if('Notification' in window) Notification.requestPermission();
});

// --- é¡µé¢åˆ‡æ¢é€»è¾‘ ---
function switchPage(id, btn) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById('page-'+id).classList.add('active');
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    // å¦‚æœåˆ‡æ¢åˆ°æ—…ç¨‹é¡µä¸”åœ°å›¾å·²åˆå§‹åŒ–ï¼Œåˆ·æ–°ä¸€ä¸‹åœ°å›¾å¤§å°é¿å…æ˜¾ç¤ºé”™è¯¯
    if(id === 'journey' && APP.map) setTimeout(()=>APP.map.invalidateSize(), 200);
}

function updateClock() {
    const d = new Date();
    document.getElementById('clockTime').textContent = d.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:false});
    document.getElementById('clockDate').textContent = d.toLocaleDateString('en-US',{weekday:'short', month:'short', day:'numeric'});
}

function showToast(msg) {
    const t = document.getElementById('toast');
    document.getElementById('toast-msg').textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2000);
}

// --- ğŸ’§ å–æ°´åŠŸèƒ½ (è¿˜åŸæˆªå›¾çš„æ ¸å¿ƒ) ---
function modWater(n) {
    if(n === 0) APP.water = 0; // é‡ç½®
    else APP.water = Math.min(APP.water + n, 12); // æœ€å¤§12æ¯
    
    localStorage.setItem('sun_water', APP.water);
    updateWaterUI();
    
    if(n>0) showToast(`Drank ${n} cup${n>1?'s':''} ğŸ’§`);
    else showToast('Water Reset ğŸ”„');
}

function updateWaterUI() {
    document.getElementById('waterVal').textContent = APP.water;
    // æ›´æ–°è¿›åº¦æ¡å®½åº¦
    document.getElementById('waterBar').style.width = Math.min((APP.water / 8 * 100), 100) + '%';
}

// --- ğŸŒ¤ï¸ å¤©æ°”åŠŸèƒ½ ---
async function getWeather(city) {
    if(!city) return;
    document.getElementById('w-desc').textContent = 'Loading...';
    
    // æ¨¡æ‹Ÿæ•°æ® (ç¡®ä¿åœ¨æ²¡æœ‰API Keyçš„æƒ…å†µä¸‹ä¹Ÿèƒ½å±•ç¤ºUI)
    let temp = 30;
    let desc = 'Sunny';
    let icon = 'â˜€ï¸';
    
    try {
        // å°è¯•ä½¿ç”¨ Open-Meteo (å…è´¹)
        const geocode = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${city}&count=1&language=en&format=json`);
        const geoData = await geocode.json();
        
        if(geoData.results && geoData.results.length > 0) {
            const {latitude, longitude, name, country} = geoData.results[0];
            const weather = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,weather_code`);
            const wData = await weather.json();
            
            temp = Math.round(wData.current.temperature_2m);
            desc = name; // ä½¿ç”¨åŸå¸‚å
            
            // ç®€å•å›¾æ ‡é€»è¾‘
            const code = wData.current.weather_code;
            if(code > 60) icon = 'ğŸŒ§ï¸';
            else if(code > 3) icon = 'â˜ï¸';
        }
    } catch(e) {
        console.log('Weather fallback used');
    }

    // æ›´æ–°é¦–é¡µ Widget
    document.getElementById('dashTemp').textContent = temp + 'Â°';
    document.getElementById('dashWeather').innerHTML = `<div class="weather-big-icon">${icon}</div><div><div class="weather-big-temp">${temp}Â°C</div><div class="weather-sub">${desc}</div></div>`;
    
    // æ›´æ–°è¯¦ç»†é¡µ
    document.getElementById('w-temp').textContent = temp + 'Â°C';
    document.getElementById('w-desc').textContent = desc;
    document.getElementById('w-icon').textContent = icon;
}

// --- ğŸš— æ—…ç¨‹è¿½è¸ª ---
function startJourney() {
    if(!navigator.geolocation) return showToast('GPS Error âŒ');
    
    APP.journey = { start: Date.now(), dist: 0, lastPos: null };
    document.getElementById('journey-start').style.display = 'none';
    document.getElementById('journey-active').style.display = 'block';
    
    // åˆå§‹åŒ–åœ°å›¾
    if(!APP.map) {
        APP.map = L.map('map-small', {zoomControl:false}).setView([1.5, 103.7], 15);
        // ä½¿ç”¨æš—è‰²åœ°å›¾ç“¦ç‰‡ä»¥åŒ¹é…ä¸»é¢˜
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(APP.map);
    }
    
    APP.watchId = navigator.geolocation.watchPosition(pos => {
        const lat = pos.coords.latitude, lon = pos.coords.longitude;
        const spd = pos.coords.speed || 0;
        
        // è®¡ç®—è·ç¦»
        if(APP.journey.lastPos) {
            APP.journey.dist += calcDist(APP.journey.lastPos.lat, APP.journey.lastPos.lon, lat, lon);
        }
        APP.journey.lastPos = {lat, lon};
        
        // æ›´æ–°UI
        document.getElementById('jDist').textContent = APP.journey.dist.toFixed(2);
        document.getElementById('jSpeed').textContent = (spd * 3.6).toFixed(1); // m/s -> km/h
        document.getElementById('jTime').textContent = Math.floor((Date.now() - APP.journey.start)/60000);
        
        // åœ°å›¾è·Ÿéš
        APP.map.setView([lat, lon]);
        L.circle([lat, lon], {color:'#0A84FF', fillOpacity:0.5, radius:20}).addTo(APP.map);
        
    }, err => showToast('GPS Signal Weak'), {enableHighAccuracy:true});
    
    showToast('Journey Started ğŸš€');
}

function stopJourney() {
    if(APP.watchId) navigator.geolocation.clearWatch(APP.watchId);
    
    const j = APP.journey;
    const timeStr = new Date().toLocaleDateString() + ' ' + new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    
    // ä¿å­˜å†å²
    APP.history.unshift({
        date: timeStr, 
        dist: j.dist.toFixed(2), 
        time: Math.floor((Date.now()-j.start)/60000)
    });
    localStorage.setItem('sun_hist', JSON.stringify(APP.history));
    
    APP.journey = null;
    
    // åˆ‡æ¢ç•Œé¢
    document.getElementById('journey-active').style.display = 'none';
    document.getElementById('journey-start').style.display = 'block';
    
    updateHistoryUI();
    showToast('Journey Saved ğŸ’¾');
}

function updateHistoryUI() {
    const c = document.getElementById('journey-list');
    c.innerHTML = APP.history.slice(0,5).map(h => 
        `<div class="list-item">
            <div>
                <div style="font-weight:600">${h.dist} km</div>
                <div class="list-item-sub">Duration: ${h.time} min</div>
            </div>
            <div style="font-size:12px;color:var(--text-tertiary)">${h.date}</div>
        </div>`
    ).join('') || '<div style="text-align:center;padding:20px;color:var(--text-tertiary)">No history yet</div>';
    
    document.getElementById('dashJourneys').textContent = APP.history.length;
}

// --- ğŸ…¿ï¸ åœè½¦åŠŸèƒ½ ---
function savePark(type) {
    if(type === 'photo') return; // input onchange handles this
    
    navigator.geolocation.getCurrentPosition(pos => {
        if(type === 'both') {
            APP.pendingGPS = {lat: pos.coords.latitude, lon: pos.coords.longitude};
            document.getElementById('cam').click(); // æ‰“å¼€ç›¸æœº
        } else {
            APP.parking = {lat: pos.coords.latitude, lon: pos.coords.longitude, time: Date.now()};
            localStorage.setItem('sun_park', JSON.stringify(APP.parking));
            updateParkingUI();
            showToast('Location Saved ğŸ“');
        }
    }, () => showToast('GPS Failed'), {enableHighAccuracy:true});
}

function handlePhoto(e) {
    const f = e.target.files[0];
    if(!f) return;
    
    const reader = new FileReader();
    reader.onload = (ev) => {
        // å¦‚æœæ˜¯ GPS+Photo æ¨¡å¼
        const lat = APP.pendingGPS ? APP.pendingGPS.lat : (APP.parking?.lat || null);
        const lon = APP.pendingGPS ? APP.pendingGPS.lon : (APP.parking?.lon || null);
        
        APP.parking = {
            time: Date.now(),
            photo: ev.target.result,
            lat: lat,
            lon: lon
        };
        APP.pendingGPS = null;
        localStorage.setItem('sun_park', JSON.stringify(APP.parking));
        updateParkingUI();
        showToast('Photo Saved ğŸ“¸');
    };
    reader.readAsDataURL(f);
}

function updateParkingUI() {
    const p = APP.parking;
    const d = document.getElementById('park-display');
    
    if(!p) { 
        d.innerHTML = 'No location saved'; 
        return; 
    }
    
    let h = `<div style="margin-bottom:10px;font-size:12px">Saved: ${new Date(p.time).toLocaleString()}</div>`;
    
    if(p.photo) h += `<img src="${p.photo}" style="width:100%;border-radius:12px;margin-bottom:12px;border:1px solid rgba(255,255,255,0.1)">`;
    
    if(p.lat) {
        h += `<a href="https://www.google.com/maps/search/?api=1&query=${p.lat},${p.lon}" target="_blank" class="btn-full btn-blue" style="text-decoration:none">ğŸ—ºï¸ Open in Google Maps</a>`;
    }
    
    h += `<button class="btn-full btn-red" style="margin-top:10px" onclick="APP.parking=null;localStorage.removeItem('sun_park');updateParkingUI()">Clear</button>`;
    
    d.innerHTML = h;
}

// --- ğŸ› ï¸ å·¥å…·åŠŸèƒ½ ---
function addRem(m) {
    const t = document.getElementById('rem-txt').value || 'Reminder';
    APP.reminders.push({text: t, time: Date.now() + m*60000});
    localStorage.setItem('sun_rems', JSON.stringify(APP.reminders));
    updateRemindersUI();
    showToast(`Remind in ${m}m â°`);
}

function updateRemindersUI() {
    const l = document.getElementById('rem-list');
    const now = Date.now();
    const active = APP.reminders.filter(r => r.time > now);
    
    l.innerHTML = active.map(r => `
        <div class="list-item">
            <span>${r.text}</span>
            <span style="color:var(--accent-blue)">${Math.ceil((r.time-now)/60000)}m</span>
        </div>
    `).join('') || '<div style="color:var(--text-tertiary);text-align:center">No active reminders</div>';
    
    document.getElementById('dashReminders').textContent = active.length;
}

function checkReminders() {
    const now = Date.now();
    APP.reminders.forEach(r => {
        if(r.time <= now && r.time > now - 15000) { // 15ç§’å†…çš„è¿‡æœŸ
            if(Notification.permission === 'granted') new Notification('Sunday', {body: r.text});
            showToast('â° ' + r.text);
        }
    });
}

async function getRates() {
    try {
        const r = await fetch('https://api.exchangerate-api.com/v4/latest/MYR');
        const d = await r.json();
        document.getElementById('rate-list').innerHTML = 
            `<div class="list-item"><span>ğŸ‡ºğŸ‡¸ USD</span><span style="color:var(--accent-green)">${(1/d.rates.USD).toFixed(3)}</span></div>` + 
            `<div class="list-item"><span>ğŸ‡¸ğŸ‡¬ SGD</span><span style="color:var(--accent-green)">${(1/d.rates.SGD).toFixed(3)}</span></div>`;
    } catch(e) {
        document.getElementById('rate-list').innerHTML = '<div class="list-item">Failed to load rates</div>';
    }
}

function getNews() {
    // æ¨¡æ‹Ÿæ–°é—»æº
    const news = [
        {t: 'Global Tech: AI Breakthroughs in 2025', s: 'TechDaily'},
        {t: 'Local: Weather Warning for Johor', s: 'MyWeather'},
        {t: 'Sports: F1 Season Finale Results', s: 'SpeedWeek'}
    ];
    document.getElementById('news-feed').innerHTML = news.map(n => 
        `<div class="list-item">
            <div>
                <div style="font-weight:500">${n.t}</div>
                <div class="list-item-sub">${n.s}</div>
            </div>
         </div>`
    ).join('');
}

// å·¥å…·å‡½æ•°
function calcDist(lat1,lon1,lat2,lon2) {
    const R=6371;
    const dLat = (lat2-lat1)*Math.PI/180;
    const dLon = (lon2-lon1)*Math.PI/180; 
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2) * Math.sin(dLon/2); 
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
    return R * c;
}
</script>
</body>
</html>
