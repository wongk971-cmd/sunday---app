<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Sunday">
    <meta name="theme-color" content="#000000">
    <title>Sunday Ultimate</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        :root {
            /* ğŸ”´ æ ¸å¿ƒæ”¹å˜ï¼šé‡‡ç”¨ Apple OLED Black ä¸»é¢˜ */
            --bg-primary: #000000;
            --bg-secondary: #1c1c1e; /* å¡ç‰‡èƒŒæ™¯ */
            --bg-tertiary: #2c2c2e;  /* æŒ‰é’®èƒŒæ™¯ */
            
            --accent-blue: #0A84FF;
            --accent-green: #30D158;
            --accent-red: #FF453A;
            --accent-orange: #FF9F0A;
            --accent-purple: #BF5AF2;
            
            --text-primary: #FFFFFF;
            --text-secondary: rgba(255,255,255,0.6);
            --text-tertiary: rgba(255,255,255,0.4);
            
            --separator: rgba(255,255,255,0.1);
            --radius-md: 14px;
            --radius-lg: 20px;
            --radius-xl: 26px;
        }

        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', system-ui, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            padding-bottom: 50px;
        }

        /* é¡¶éƒ¨å¾®å¼±è“å…‰ (Ambient Light) */
        .ambient-light {
            position: fixed; top: -150px; left: -150px; width: 350px; height: 350px;
            background: radial-gradient(circle, rgba(10,132,255,0.15) 0%, transparent 70%);
            z-index: -1; pointer-events: none;
        }

        .app-container { max-width: 440px; margin: 0 auto; padding: 0 16px; }

        /* --- Header (å®Œç¾è¿˜åŸæˆªå›¾) --- */
        .header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 16px 0 20px;
        }
        .logo { display: flex; align-items: center; gap: 12px; }
        .logo-icon {
            width: 44px; height: 44px;
            background: linear-gradient(135deg, #0A84FF, #5AC8FA); /* æˆªå›¾é‡Œçš„è“è‰²å›¾æ ‡ */
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 15px rgba(10,132,255,0.3);
        }
        .logo-icon img { width: 100%; height: 100%; object-fit: cover; border-radius: 12px; }
        
        .logo-text h1 { font-size: 22px; font-weight: 700; line-height: 1.1; letter-spacing: -0.5px; }
        .logo-text span { font-size: 11px; color: var(--text-tertiary); letter-spacing: 0.5px; text-transform: uppercase; font-weight: 500; }
        
        .header-time { text-align: right; }
        .header-time .time { font-size: 26px; font-weight: 700; color: var(--accent-blue); line-height: 1; font-variant-numeric: tabular-nums; }
        .header-time .date { font-size: 11px; color: var(--text-tertiary); margin-top: 4px; }

        /* --- Nav (èƒ¶å›Šå¯¼èˆª) --- */
        .nav-tabs {
            display: flex; gap: 6px; padding: 4px;
            background: var(--bg-secondary);
            border-radius: 16px;
            margin-bottom: 24px;
            overflow-x: auto;
            scrollbar-width: none;
        }
        .nav-tabs::-webkit-scrollbar { display: none; }
        .nav-tab {
            flex: 1; min-width: 60px; padding: 10px 0;
            border: none; background: transparent;
            color: var(--text-secondary);
            font-family: inherit; font-size: 11px; font-weight: 500;
            border-radius: 12px; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            transition: all 0.2s;
        }
        .nav-tab.active { background: var(--accent-blue); color: white; box-shadow: 0 4px 12px rgba(10,132,255,0.3); }
        .nav-tab .icon { font-size: 20px; margin-bottom: 2px; }

        /* --- Pages --- */
        .page { display: none; animation: fadeIn 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

        /* --- V10 ç»„ä»¶é£æ ¼ (é»‘è‰²å¡ç‰‡) --- */
        .card {
            background: var(--bg-secondary);
            border-radius: var(--radius-xl);
            padding: 20px;
            margin-bottom: 16px;
            border: none; /* ç§»é™¤ V9 çš„ç»ç’ƒè¾¹æ¡† */
        }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .card-title { font-size: 17px; font-weight: 600; color: white; display: flex; align-items: center; gap: 8px; }

        /* 1. é¦–é¡µæ–¹å— (Stats Grid - è¿˜åŸæˆªå›¾) */
        .stats-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px;
        }
        .stat-item {
            background: var(--bg-secondary);
            aspect-ratio: 1;
            border-radius: var(--radius-lg);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 8px;
            border: none;
        }
        .stat-value { font-size: 20px; font-weight: 700; color: var(--accent-blue); margin-bottom: 2px; }
        .stat-label { font-size: 11px; color: var(--text-secondary); }

        /* 2. ğŸ’§ å–æ°´å¡ç‰‡ (V9æ²¡æœ‰, ä½†æˆªå›¾æœ‰, è¿™é‡Œè¡¥å…¨äº†) */
        .hydration-card {
            background: linear-gradient(180deg, rgba(10,132,255,0.08) 0%, rgba(28,28,30,0) 100%), var(--bg-secondary);
            border: 1px solid rgba(10,132,255,0.15);
            border-radius: var(--radius-xl);
            padding: 20px;
            margin-bottom: 16px;
        }
        .hyd-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .hyd-title { font-size: 17px; font-weight: 600; color: white; display: flex; align-items: center; gap: 8px; }
        .hyd-count { font-size: 30px; font-weight: 700; color: white; }
        .hyd-count span { font-size: 15px; color: var(--text-tertiary); font-weight: 500; }
        
        .hyd-progress-bg { height: 10px; background: rgba(255,255,255,0.1); border-radius: 100px; overflow: hidden; margin-bottom: 20px; }
        .hyd-progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent-blue), var(--accent-teal)); width: 0%; transition: width 0.5s ease; }
        
        .hyd-btn-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .hyd-btn {
            background: var(--bg-tertiary); border: none;
            padding: 14px 0; border-radius: var(--radius-md);
            color: white; font-weight: 600; font-size: 13px; cursor: pointer;
        }
        .hyd-btn:active { background: var(--text-secondary); }

        /* 3. å¤©æ°” & å¾½ç«  */
        .badge { padding: 5px 10px; border-radius: 100px; font-size: 11px; font-weight: 700; background: var(--bg-tertiary); }
        .badge.live { background: rgba(255,69,58,0.15); color: var(--accent-red); animation: pulse 1.5s infinite; display: flex; align-items: center; gap: 4px; }
        .badge.live::before { content:''; width:6px; height:6px; background:currentColor; border-radius:50%; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

        .weather-main { display: flex; align-items: center; gap: 16px; }
        .weather-icon { font-size: 48px; }
        .weather-temp { font-size: 44px; font-weight: 700; letter-spacing: -1px; }
        .weather-condition { font-size: 15px; color: var(--text-secondary); margin-top: 2px; }
        
        .weather-details { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 16px; }
        .weather-detail { background: var(--bg-tertiary); padding: 12px; border-radius: var(--radius-md); text-align: center; }
        .weather-detail .value { font-size: 16px; font-weight: 600; color: white; }
        .weather-detail .label { font-size: 10px; color: var(--text-tertiary); margin-top: 2px; }

        /* 4. è¾“å…¥æ¡† & æŒ‰é’® (V9 çš„åŠŸèƒ½, V10 çš„çš®) */
        .input-group { position: relative; margin-bottom: 12px; }
        .input-field { width: 100%; padding: 16px; background: var(--bg-tertiary); border: none; border-radius: var(--radius-md); color: white; font-size: 16px; font-family: inherit; }
        .input-field:focus { outline: none; box-shadow: 0 0 0 2px var(--accent-blue); }
        
        .btn { width: 100%; padding: 16px; border-radius: var(--radius-md); border: none; font-weight: 600; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--accent-blue); color: white; }
        .btn-secondary { background: var(--bg-tertiary); color: white; }
        .btn-danger { background: var(--accent-red); color: white; }
        .btn-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .btn-sm { padding: 12px 16px; font-size: 13px; }

        /* 5. åœ°å›¾ä¸æ—¶é—´è½´ (ä¿ç•™äº† V9 çš„é«˜çº§åŠŸèƒ½) */
        .map-small-container { width: 100%; height: 200px; border-radius: var(--radius-lg); overflow: hidden; margin-bottom: 16px; position: relative; background: var(--bg-tertiary); }
        .map-fullscreen { position: fixed; inset: 0; z-index: 2000; background: black; display: none; }
        .map-fullscreen.active { display: block; }
        #journeyMapFull { width: 100%; height: 100%; }
        
        /* åœ°å›¾è¦†ç›–å±‚ */
        .map-top-bar { position: absolute; top: 0; left: 0; right: 0; padding: 60px 20px 20px; background: linear-gradient(180deg, rgba(0,0,0,0.9), transparent); z-index: 2001; pointer-events: none; }
        .map-status-row { display: flex; align-items: center; gap: 12px; pointer-events: auto; }
        .map-mode-icon { width: 48px; height: 48px; background: var(--accent-blue); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 4px 12px rgba(10,132,255,0.4); }
        .map-mode-info { flex: 1; color: white; }
        .map-mode-title { font-size: 20px; font-weight: 700; }
        .map-street { font-size: 13px; opacity: 0.7; }
        .map-close-btn { width: 36px; height: 36px; background: rgba(255,255,255,0.2); border-radius: 50%; border:none; color: white; font-size: 18px; cursor: pointer; pointer-events: auto; }
        
        .map-bottom-bar { position: absolute; bottom: 0; left: 0; right: 0; padding: 40px 20px; background: linear-gradient(0deg, rgba(0,0,0,0.95), transparent); z-index: 2001; pointer-events: none; }
        .map-controls { display: flex; justify-content: center; gap: 16px; pointer-events: auto; }
        .map-btn { width: 56px; height: 56px; background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); border-radius: 50%; border: none; font-size: 24px; color: white; cursor: pointer; }
        .map-btn-end { background: var(--accent-red); width: 72px; height: 72px; font-size: 30px; box-shadow: 0 0 20px rgba(255,69,58,0.4); }

        /* 6. èŠå¤©ç•Œé¢ (V9 ç‹¬æœ‰åŠŸèƒ½ï¼Œå·²é€‚é…é»‘å¤œæ¨¡å¼) */
        .chat-messages { height: 300px; overflow-y: auto; background: var(--bg-tertiary); border-radius: var(--radius-md); padding: 16px; margin-bottom: 12px; }
        .chat-message { margin-bottom: 12px; display: flex; }
        .chat-message.bot { justify-content: flex-start; }
        .chat-message.user { justify-content: flex-end; }
        .chat-bubble { max-width: 80%; padding: 10px 14px; border-radius: 16px; font-size: 15px; }
        .chat-message.bot .chat-bubble { background: var(--bg-secondary); color: var(--text-secondary); }
        .chat-message.user .chat-bubble { background: var(--accent-blue); color: white; }
        .chat-input-area { display: flex; gap: 10px; }

        /* 7. æœç´¢ç»“æœ & åˆ—è¡¨ */
        .search-results { position: absolute; top: 100%; left: 0; right: 0; background: var(--bg-secondary); border: 1px solid var(--separator); border-radius: var(--radius-md); margin-top: 8px; z-index: 3000; display: none; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        .search-results.active { display: block; }
        .search-item { padding: 14px 16px; border-bottom: 1px solid var(--separator); cursor: pointer; }
        .search-item:last-child { border-bottom: none; }
        .search-item-name { color: white; font-weight: 500; }
        .search-item-detail { font-size: 12px; color: var(--text-tertiary); }

        .list-item { display: flex; align-items: center; justify-content: space-between; padding: 16px; background: var(--bg-tertiary); border-radius: var(--radius-md); margin-bottom: 8px; }
        
        .alert-card { padding: 16px; border-radius: var(--radius-md); margin-bottom: 10px; background: rgba(255,69,58,0.1); border-left: 4px solid var(--accent-red); }
        .alert-card.info { background: rgba(10,132,255,0.1); border-color: var(--accent-blue); }
        
        /* Utils */
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-150%); background: rgba(44,44,46,0.9); backdrop-filter: blur(20px); padding: 12px 24px; border-radius: 50px; display: flex; align-items: center; gap: 10px; z-index: 5000; transition: 0.4s; box-shadow: 0 10px 30px rgba(0,0,0,0.5); width: max-content; }
        .toast.show { transform: translateX(-50%) translateY(0); }
        
        /* éšè—å…ƒç´  */
        #photoInput, #journeyPhotoInput, #cam { display: none; }
    </style>
</head>
<body>

    <div class="ambient-light"></div>

    <div class="app-container">
        <header class="header">
            <div class="logo">
                <div class="logo-icon"><img src="logosunday.jpg" alt="S" onerror="this.style.display='none';this.parentElement.innerHTML='â˜€ï¸'"></div>
                <div class="logo-text"><h1>Sunday</h1><span>PERSONAL ASSISTANT</span></div>
            </div>
            <div class="header-time">
                <div class="time" id="currentTime">00:00</div>
                <div class="date" id="currentDate">Mon, Jan 1</div>
            </div>
        </header>

        <nav class="nav-tabs">
            <button class="nav-tab active" data-page="dashboard"><span class="icon">ğŸ </span>Home</button>
            <button class="nav-tab" data-page="weather"><span class="icon">ğŸŒ¤ï¸</span>Weather</button>
            <button class="nav-tab" data-page="journey"><span class="icon">ğŸ—ºï¸</span>Journey</button>
            <button class="nav-tab" data-page="parking"><span class="icon">ğŸ…¿ï¸</span>Parking</button>
            <button class="nav-tab" data-page="tools"><span class="icon">ğŸ› ï¸</span>Tools</button>
            <button class="nav-tab" data-page="alerts"><span class="icon">ğŸš¨</span>Alerts</button>
            <button class="nav-tab" data-page="chat"><span class="icon">ğŸ’¬</span>Chat</button>
        </nav>

        <div class="page active" id="page-dashboard">
            <div id="dailyBriefing" style="display:none; margin-bottom:16px; padding:12px; background:rgba(10,132,255,0.1); border-radius:14px; border-left:3px solid var(--accent-blue);">
                <div style="font-weight:700; color:var(--accent-blue); margin-bottom:4px">ğŸ”” Morning Brief</div>
                <div id="briefingContent" style="font-size:12px; color:var(--text-secondary)">Loading...</div>
            </div>

            <div class="stats-grid">
                <div class="stat-item"><div class="stat-value" id="dashTemp">--Â°</div><div class="stat-label">Temp</div></div>
                <div class="stat-item"><div class="stat-value" id="dashAlerts">0</div><div class="stat-label">Alerts</div></div>
                <div class="stat-item"><div class="stat-value" id="dashJourneys">0</div><div class="stat-label">Journeys</div></div>
                <div class="stat-item"><div class="stat-value" id="dashReminders">0</div><div class="stat-label">Reminders</div></div>
            </div>

            <div class="hydration-card">
                <div class="hyd-header">
                    <div class="hyd-title">ğŸ’§ Hydration</div>
                    <div class="hyd-count"><span id="waterCount">0</span><span>/8</span></div>
                </div>
                <div class="hyd-progress-bg"><div class="hyd-progress-fill" id="waterBar"></div></div>
                <div class="hyd-btn-row">
                    <button class="hyd-btn" onclick="modWater(1)">+1 Cup</button>
                    <button class="hyd-btn" onclick="modWater(2)">+2 Cups</button>
                    <button class="hyd-btn" onclick="modWater(0)">Reset</button>
                </div>
            </div>

            <div class="card">
                <div class="card-header"><div class="card-title">ğŸŒ¤ï¸ Weather</div><span class="badge live">â— LIVE</span></div>
                <div class="weather-main" id="dashWeather">
                    <div class="weather-icon">â˜€ï¸</div>
                    <div><div class="weather-temp">--Â°C</div><div class="weather-condition">Loading...</div></div>
                </div>
            </div>

            <div class="card">
                <div class="card-header"><div class="card-title">ğŸ“° News</div></div>
                <div id="dashNews" style="font-size:13px; color:var(--text-secondary)">Loading...</div>
            </div>
            <div id="dashAlertsPreview"></div>
        </div>

        <div class="page" id="page-weather">
            <div class="input-group">
                <input type="text" class="input-field" id="weatherSearch" placeholder="ğŸ” Search city..." autocomplete="off">
                <div id="searchResults" class="search-results"></div>
            </div>
            <div class="card">
                <div class="card-header"><div class="card-title">ğŸ“ <span id="weatherLocation">Johor Jaya</span></div></div>
                <div class="weather-main">
                    <div class="weather-icon" id="weatherIcon">â˜€ï¸</div>
                    <div><div class="weather-temp"><span id="weatherTemp">--</span>Â°C</div><div class="weather-condition" id="weatherCondition">Loading...</div></div>
                </div>
                <div class="weather-details">
                    <div class="weather-detail"><div class="value" id="weatherWind">--</div><div class="label">Wind</div></div>
                    <div class="weather-detail"><div class="value" id="weatherHumidity">--</div><div class="label">Hum %</div></div>
                    <div class="weather-detail"><div class="value" id="weatherRain">--</div><div class="label">Rain %</div></div>
                </div>
            </div>
            <div class="card">
                <div class="card-header"><div class="card-title">ğŸŒ Locations</div></div>
                <div id="monitoredLocations"></div>
            </div>
        </div>

        <div class="page" id="page-journey">
            <div class="card" id="activeJourneyCard" style="display:none; border:1px solid var(--accent-green)">
                <div class="card-header"><div class="card-title" style="color:var(--accent-green)">ğŸš— Tracking Active</div><span class="badge live" style="background:rgba(48,209,88,0.2);color:#30D158">REC</span></div>
                <div class="stats-grid" style="grid-template-columns:1fr 1fr 1fr; margin-bottom:16px">
                    <div class="stat-item"><div class="stat-value" id="jDistance">0.0</div><div class="stat-label">km</div></div>
                    <div class="stat-item"><div class="stat-value" id="jSpeed">0</div><div class="stat-label">km/h</div></div>
                    <div class="stat-item"><div class="stat-value" id="jTime">0</div><div class="stat-label">min</div></div>
                </div>
                <div class="map-small-container" onclick="openFullscreenMap()"><div id="journeyMapSmall"></div></div>
                <div class="btn-row">
                    <button class="btn btn-secondary" onclick="openFullscreenMap()">ğŸ—ºï¸ Map</button>
                    <button class="btn btn-danger" onclick="endJourney()">Stop ğŸ</button>
                </div>
            </div>

            <div class="card" id="startJourneyCard">
                <div class="card-header"><div class="card-title">ğŸš€ New Journey</div></div>
                <div style="text-align:center; padding:20px; color:var(--text-tertiary); font-size:13px">
                    GPS Tracking â€¢ Auto Speed Detection â€¢ Calorie Counter
                </div>
                <button class="btn btn-primary" onclick="startJourney()">Start Tracking</button>
            </div>

            <div class="card">
                <div class="card-header"><div class="card-title">ğŸ“œ History</div></div>
                <div id="journeyHistory"></div>
            </div>
        </div>

        <div class="page" id="page-parking">
            <div class="card">
                <div class="card-header"><div class="card-title">ğŸš— My Car</div></div>
                <div id="parkingDisplay" style="text-align:center; padding:30px; color:var(--text-tertiary)">No location saved</div>
                <div class="map-small-container" id="parkingMapContainer" style="display:none"><div id="parkingMap"></div></div>
                <div class="btn-row-3">
                    <button class="btn btn-primary btn-sm" onclick="saveParking('gps')">ğŸ“ GPS</button>
                    <button class="btn btn-secondary btn-sm" onclick="document.getElementById('photoInput').click()">ğŸ“¸ Photo</button>
                    <button class="btn btn-secondary btn-sm" onclick="saveParking('both')">ğŸ“+ğŸ“¸</button>
                </div>
                <input type="file" id="photoInput" accept="image/*" capture="environment" onchange="handlePhoto(event)">
            </div>
            <div class="card">
                <div class="card-header"><div class="card-title">â­ Saved Places</div></div>
                <div class="input-group"><input type="text" class="input-field" id="customPlaceName" placeholder="Place Name"></div>
                <button class="btn btn-secondary" onclick="saveCustomPlace()">Save Current Location</button>
                <div id="customPlacesList" style="margin-top:16px"></div>
            </div>
        </div>

        <div class="page" id="page-tools">
            <div class="card">
                <div class="card-header"><div class="card-title">â° Reminders</div></div>
                <div class="input-group"><input type="text" class="input-field" id="reminderTask" placeholder="Remind me to..."></div>
                <div class="btn-row">
                    <button class="btn btn-secondary" onclick="addReminder(null, 30)">+30m</button>
                    <button class="btn btn-primary" onclick="addReminder()">Set</button>
                </div>
                <div id="reminderList" style="margin-top:16px"></div>
                <select id="reminderTime" style="display:none"><option value="30" selected>30</option></select>
            </div>
            <div class="card">
                <div class="card-header"><div class="card-title">ğŸ’± Exchange Rates (MYR)</div></div>
                <div id="currencyRates">Loading...</div>
            </div>
        </div>

        <div class="page" id="page-alerts">
            <div class="card">
                <div class="card-header"><div class="card-title">ğŸš¨ Earthquakes (USGS)</div></div>
                <div id="earthquakeAlerts">Loading...</div>
            </div>
            <div class="card">
                <div class="card-header"><div class="card-title">ğŸŒ Global Weather Watch</div></div>
                <div id="globalWeatherAlerts">Loading...</div>
            </div>
        </div>

        <div class="page" id="page-chat">
            <div class="card" style="height:calc(100vh - 180px); display:flex; flex-direction:column">
                <div class="card-header"><div class="card-title">ğŸ’¬ Assistant</div></div>
                <div class="chat-messages" id="chatMessages">
                    <div class="chat-message bot"><div class="chat-bubble">Hi! I'm Sunday. I can help with weather, medical tips, or tools.</div></div>
                </div>
                <div class="chat-input-area">
                    <input type="text" class="input-field" id="chatInput" placeholder="Type..." onkeypress="if(event.key==='Enter')sendChat()">
                    <button class="btn btn-primary" style="width:auto" onclick="sendChat()">â¤</button>
                </div>
            </div>
        </div>
    </div>

    <div class="map-fullscreen" id="mapFullscreen">
        <div id="journeyMapFull"></div>
        <div class="map-top-bar">
            <div class="map-status-row">
                <div class="map-mode-icon" id="fsModeIcon">ğŸš¶</div>
                <div class="map-mode-info">
                    <div class="map-mode-title" id="fsModeTitle">Tracking</div>
                    <div class="map-street" id="fsStreet">Locating...</div>
                </div>
                <button class="map-close-btn" onclick="closeFullscreenMap()">âœ•</button>
            </div>
        </div>
        <div class="map-bottom-bar">
            <div style="text-align:center; margin-bottom:20px">
                <div style="font-size:48px; font-weight:700; color:var(--accent-green); font-variant-numeric: tabular-nums;" id="fsDuration">00:00</div>
            </div>
            <div class="map-controls">
                <button class="map-btn" onclick="centerMapOnUser()">ğŸ“</button>
                <button class="map-btn map-btn-end" onclick="endJourney()">ğŸ</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"><span class="toast-icon">âœ…</span><span class="toast-message">Success</span></div>

    <script>
        // ==================== 1. CORE LOGIC (V9.1 Base) ====================
        const APP = { journey: null, watchId: null, mapSmall: null, mapFull: null, markerSmall: null, markerFull: null, pathSmall: null, pathFull: null, pathCoords: [], parkingMap: null, reminders: [], parking: null, customPlaces: {}, journeyHistory: [], pendingPhoto: null, timerInterval: null, isFullscreen: false, water: 0 };
        const LOCATIONS = { 'Johor Jaya': { lat: 1.5360, lon: 103.7930 }, 'Singapore': { lat: 1.3521, lon: 103.8198 }, 'Tokyo': { lat: 35.6895, lon: 139.6917 }, 'London': { lat: 51.5074, lon: -0.1278 } };
        const GLOBAL_MONITOR = [{n:'Tokyo', lat:35.6895, lon:139.6917}, {n:'London', lat:51.5074, lon:-0.1278}, {n:'Singapore', lat:1.3521, lon:103.8198}];
        const CURRENCIES = [{ code: 'USD', flag: 'ğŸ‡ºğŸ‡¸' }, { code: 'SGD', flag: 'ğŸ‡¸ğŸ‡¬' }, { code: 'JPY', flag: 'ğŸ‡¯ğŸ‡µ' }];

        document.addEventListener('DOMContentLoaded', () => {
            loadStorage(); initNav(); updateClock(); setInterval(updateClock, 1000);
            loadWeather(); loadNews(); loadCurrency(); loadEarthquakes(); loadGlobalWeatherAlerts();
            renderReminders(); renderParking(); renderHistory(); renderPlaces(); generateDailyBriefing();
            updateWaterUI(); // New for V10
            setInterval(checkReminders, 10000); setInterval(loadEarthquakes, 300000);
            if ('Notification' in window) Notification.requestPermission();
        });

        function loadStorage() {
            try { APP.reminders = JSON.parse(localStorage.getItem('sun_rem') || '[]'); APP.parking = JSON.parse(localStorage.getItem('sun_park') || 'null'); APP.customPlaces = JSON.parse(localStorage.getItem('sun_places') || '{}'); APP.journeyHistory = JSON.parse(localStorage.getItem('sun_hist') || '[]'); APP.water = parseInt(localStorage.getItem('sun_water') || '0'); } catch(e) {}
        }
        function saveStorage() {
            localStorage.setItem('sun_rem', JSON.stringify(APP.reminders)); localStorage.setItem('sun_park', JSON.stringify(APP.parking)); localStorage.setItem('sun_places', JSON.stringify(APP.customPlaces)); localStorage.setItem('sun_hist', JSON.stringify(APP.journeyHistory)); localStorage.setItem('sun_water', APP.water);
        }
        function initNav() {
            document.querySelectorAll('.nav-tab').forEach(t => t.addEventListener('click', () => { document.querySelectorAll('.nav-tab').forEach(x => x.classList.remove('active')); document.querySelectorAll('.page').forEach(x => x.classList.remove('active')); t.classList.add('active'); document.getElementById('page-' + t.dataset.page).classList.add('active'); }));
        }
        function updateClock() {
            const now = new Date(); document.getElementById('currentTime').textContent = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false }); document.getElementById('currentDate').textContent = now.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        }

        // ==================== 2. HYDRATION (NEW FOR V10) ====================
        function modWater(n) {
            if(n === 0) APP.water = 0;
            else APP.water = Math.min(APP.water + n, 12);
            saveStorage(); updateWaterUI();
        }
        function updateWaterUI() {
            document.getElementById('waterCount').textContent = APP.water;
            document.getElementById('waterBar').style.width = (APP.water / 8 * 100) + '%';
        }

        // ==================== 3. WEATHER & SEARCH (From V9) ====================
        async function loadWeather() { await updateWeather('Johor Jaya', 1.536, 103.793); const container = document.getElementById('monitoredLocations'); container.innerHTML = ''; for (const [n, c] of Object.entries(LOCATIONS)) { try { const d = await (await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${c.lat}&longitude=${c.lon}&current=temperature_2m,weather_code`)).json(); const cond = getWeatherCond(d.current.weather_code); container.innerHTML += `<div class="list-item" onclick="updateWeather('${n}',${c.lat},${c.lon})"><div style="display:flex;align-items:center;gap:10px"><span style="font-size:20px">${cond.icon}</span><span>${n}</span></div><span style="font-weight:600;color:var(--accent-blue)">${Math.round(d.current.temperature_2m)}Â°</span></div>`; } catch(e) {} } }
        async function updateWeather(name, lat, lon) { try { const d = await (await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code,wind_speed_10m,relative_humidity_2m&hourly=precipitation_probability`)).json(); const temp = Math.round(d.current.temperature_2m); const cond = getWeatherCond(d.current.weather_code); document.getElementById('weatherLocation').textContent = name; document.getElementById('weatherTemp').textContent = temp; document.getElementById('weatherIcon').textContent = cond.icon; document.getElementById('weatherCondition').textContent = cond.text; document.getElementById('weatherWind').textContent = Math.round(d.current.wind_speed_10m); document.getElementById('weatherHumidity').textContent = d.current.relative_humidity_2m; document.getElementById('weatherRain').textContent = d.hourly.precipitation_probability[0] || 0; document.getElementById('dashTemp').textContent = temp + 'Â°'; document.getElementById('dashWeather').innerHTML = `<div class="weather-icon">${cond.icon}</div><div><div class="weather-temp">${temp}Â°C</div><div class="weather-condition">${name}</div></div>`; return `${cond.icon} ${name}: ${temp}Â°C`; } catch(e) { return 'Error'; } }
        function getWeatherCond(code) { if (code === 0) return { icon: 'â˜€ï¸', text: 'Clear' }; if (code <= 3) return { icon: 'â›…', text: 'Cloudy' }; if (code >= 95) return { icon: 'â›ˆï¸', text: 'Storm' }; if (code >= 61) return { icon: 'ğŸŒ§ï¸', text: 'Rain' }; return { icon: 'â˜ï¸', text: 'Cloudy' }; }
        
        // Smart Search
        const searchInput = document.getElementById('weatherSearch'); const searchResults = document.getElementById('searchResults');
        searchInput.addEventListener('keyup', async (e) => { if (e.key === 'Enter') { const query = e.target.value.trim(); if (!query) return; searchResults.innerHTML = '<div class="search-item">Searching...</div>'; searchResults.classList.add('active'); try { const r = await (await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(query)}&count=5&language=en&format=json`)).json(); searchResults.innerHTML = r.results ? r.results.map(i => `<div class="search-item" onclick="selectLocation('${i.name}', ${i.latitude}, ${i.longitude}, '${i.country||''}')"><div class="search-item-name">${i.name}</div><div class="search-item-detail">${i.country||''}</div></div>`).join('') : '<div class="search-item">No results</div>'; } catch(err) { searchResults.classList.remove('active'); } } });
        document.addEventListener('click', (e) => { if (!e.target.closest('.input-group')) searchResults.classList.remove('active'); });
        function selectLocation(n, lat, lon, c) { updateWeather(n, lat, lon); searchInput.value = `${n}, ${c}`; searchResults.classList.remove('active'); }

        // ==================== 4. ALERTS & EARTHQUAKES (From V9) ====================
        async function loadGlobalWeatherAlerts() { const c = document.getElementById('globalWeatherAlerts'); let found=false, h=''; for(const city of GLOBAL_MONITOR){ try{ const d=await(await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${city.lat}&longitude=${city.lon}&current=weather_code`)).json(); if([95,96,99].includes(d.current.weather_code)){ found=true; h+=`<div class="alert-card"><div style="font-weight:600">ğŸš¨ ${city.n}</div><div>Thunderstorm Alert</div></div>`; } }catch(e){} } if(!found) h='<div class="list-item" style="color:var(--text-secondary)">No severe alerts</div>'; c.innerHTML=h; }
        async function loadEarthquakes() { try { const q = (await (await fetch('https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/4.5_day.geojson')).json()).features; document.getElementById('dashAlerts').textContent = q.length; document.getElementById('earthquakeAlerts').innerHTML = q.slice(0, 10).map(x => `<div class="list-item"><div><div style="font-weight:600">${x.properties.place}</div><div style="font-size:12px;color:var(--text-tertiary)">${new Date(x.properties.time).toLocaleString()}</div></div><span class="badge" style="background:${x.properties.mag>=6?'var(--accent-red)':'var(--accent-orange)'};color:white">M${x.properties.mag.toFixed(1)}</span></div>`).join(''); document.getElementById('dashAlertsPreview').innerHTML = q.slice(0,1).map(x=>`<div class="alert-card"><div style="font-weight:600">ğŸš¨ Recent: M${x.properties.mag.toFixed(1)}</div><div>${x.properties.place}</div></div>`).join(''); } catch(e) {} }

        // ==================== 5. JOURNEY (From V9 + Map) ====================
        function startJourney() {
            if (!navigator.geolocation) return showToast('GPS not supported', true);
            navigator.geolocation.getCurrentPosition(pos => {
                const lat = pos.coords.latitude, lon = pos.coords.longitude;
                APP.journey = { startTime: Date.now(), lastLat: lat, lastLon: lon, totalKm: 0, speed: 0 };
                APP.pathCoords = [[lat, lon]];
                document.getElementById('startJourneyCard').style.display = 'none'; document.getElementById('activeJourneyCard').style.display = 'block';
                setTimeout(() => {
                    APP.mapSmall = L.map('journeyMapSmall', { zoomControl: false }).setView([lat, lon], 17); L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(APP.mapSmall);
                    APP.pathSmall = L.polyline(APP.pathCoords, { color: '#0A84FF', weight: 4 }).addTo(APP.mapSmall);
                }, 100);
                APP.watchId = navigator.geolocation.watchPosition(trackPosition, null, { enableHighAccuracy: true });
                APP.timerInterval = setInterval(() => { const mins = Math.floor((Date.now()-APP.journey.startTime)/60000); document.getElementById('jTime').textContent=mins; document.getElementById('fsDuration').textContent = new Date(Date.now()-APP.journey.startTime).toISOString().substr(11,8); }, 1000);
            }, null, { enableHighAccuracy: true });
        }
        function trackPosition(pos) {
            if (!APP.journey) return;
            const lat = pos.coords.latitude, lon = pos.coords.longitude, j = APP.journey;
            const dist = calcDist(j.lastLat, j.lastLon, lat, lon);
            if (dist > 0.005) {
                j.totalKm += dist; j.speed = (dist / ((Date.now() - j.startTime)/3600000)) || 0; // rough speed
                j.lastLat = lat; j.lastLon = lon; APP.pathCoords.push([lat, lon]);
                if (APP.mapSmall) { APP.pathSmall.setLatLngs(APP.pathCoords); APP.mapSmall.panTo([lat, lon]); }
                if (APP.mapFull) { APP.pathFull.setLatLngs(APP.pathCoords); APP.mapFull.panTo([lat, lon]); }
                document.getElementById('jDistance').textContent = j.totalKm.toFixed(2); document.getElementById('jSpeed').textContent = (pos.coords.speed*3.6||0).toFixed(1);
            }
        }
        function endJourney() {
            if (APP.watchId) navigator.geolocation.clearWatch(APP.watchId); clearInterval(APP.timerInterval);
            const j = APP.journey;
            APP.journeyHistory.unshift({ id: Date.now(), date: new Date().toISOString(), distance: j.totalKm.toFixed(2), duration: Math.floor((Date.now()-j.startTime)/60000) });
            saveStorage(); APP.journey = null; APP.pathCoords = [];
            document.getElementById('activeJourneyCard').style.display = 'none'; document.getElementById('startJourneyCard').style.display = 'block';
            closeFullscreenMap(); renderHistory();
        }
        function renderHistory() { const c = document.getElementById('journeyHistory'); c.innerHTML = APP.journeyHistory.slice(0, 10).map(j => `<div class="list-item"><div><div style="font-weight:600">${j.distance} km</div><div style="font-size:12px;color:var(--text-tertiary)">${new Date(j.date).toLocaleDateString()}</div></div><span style="color:var(--accent-blue)">${j.duration} min</span></div>`).join(''); document.getElementById('dashJourneys').textContent = APP.journeyHistory.length; }
        function openFullscreenMap() { if(!APP.journey) return; document.getElementById('mapFullscreen').classList.add('active'); setTimeout(()=>{ if(APP.mapFull) APP.mapFull.remove(); APP.mapFull = L.map('journeyMapFull',{zoomControl:false}).setView([APP.journey.lastLat, APP.journey.lastLon], 17); L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(APP.mapFull); APP.pathFull = L.polyline(APP.pathCoords, {color:'#0A84FF', weight:5}).addTo(APP.mapFull); },100); }
        function closeFullscreenMap() { document.getElementById('mapFullscreen').classList.remove('active'); }
        function centerMapOnUser() { if(APP.journey && APP.mapFull) APP.mapFull.setView([APP.journey.lastLat, APP.journey.lastLon], 17); }

        // ==================== 6. PARKING & TOOLS (From V9) ====================
        function handlePhoto(e) { const f = e.target.files[0]; const r = new FileReader(); r.onload = ev => { APP.pendingPhoto = ev.target.result; if(APP.pendingMode==='both') finishSave('both'); else { APP.parking={type:'photo', photo:ev.target.result, time:Date.now()}; saveStorage(); renderParking(); } }; r.readAsDataURL(f); }
        function saveParking(type) { APP.pendingMode = type; if(type==='photo') document.getElementById('photoInput').click(); else navigator.geolocation.getCurrentPosition(pos => { APP.pendingGPS={lat:pos.coords.latitude, lon:pos.coords.longitude}; if(type==='both') document.getElementById('photoInput').click(); else finishSave('gps'); }); }
        function finishSave(type) { APP.parking = { type, time: Date.now(), lat: APP.pendingGPS?.lat, lon: APP.pendingGPS?.lon, photo: APP.pendingPhoto }; saveStorage(); renderParking(); }
        function renderParking() { const p = APP.parking; const d = document.getElementById('parkingDisplay'); const m = document.getElementById('parkingMapContainer'); if(!p) { d.innerHTML='No location'; m.style.display='none'; return; } d.innerHTML = `Saved: ${new Date(p.time).toLocaleTimeString()}` + (p.photo?`<br><img src="${p.photo}" class="parking-photo" style="width:100%;margin-top:10px;border-radius:10px">`:''); if(p.lat) { m.style.display='block'; setTimeout(()=>{ if(APP.parkingMap) APP.parkingMap.remove(); APP.parkingMap = L.map('parkingMap',{zoomControl:false}).setView([p.lat, p.lon], 17); L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(APP.parkingMap); L.marker([p.lat, p.lon]).addTo(APP.parkingMap); },100); } }
        function saveCustomPlace() { const n = document.getElementById('customPlaceName').value; if(n && APP.parking?.lat) { APP.customPlaces[n] = APP.parking; saveStorage(); renderPlaces(); } }
        function renderPlaces() { document.getElementById('customPlacesList').innerHTML = Object.keys(APP.customPlaces).map(n => `<div class="list-item"><span>${n}</span><button class="btn btn-secondary btn-sm" style="width:auto" onclick="window.open('http://maps.google.com/?q=${APP.customPlaces[n].lat},${APP.customPlaces[n].lon}')">Go</button></div>`).join(''); }
        
        function addReminder(task, mins) { task = task || document.getElementById('reminderTask').value; mins = mins || parseInt(document.getElementById('reminderTime').value); if(!task) return; APP.reminders.push({id:Date.now(), task, time:Date.now()+mins*60000}); saveStorage(); renderReminders(); showToast('Reminder Set'); }
        function renderReminders() { const l = document.getElementById('reminderList'); l.innerHTML = APP.reminders.map(r => `<div class="list-item"><span>${r.task}</span><span>${Math.ceil((r.time-Date.now())/60000)}m</span></div>`).join(''); document.getElementById('dashReminders').textContent = APP.reminders.length; }
        function checkReminders() { const now=Date.now(); APP.reminders.forEach(r=>{ if(r.time<=now){ showToast(r.task); if(Notification.permission==='granted') new Notification(r.task); } }); APP.reminders=APP.reminders.filter(r=>r.time>now); saveStorage(); renderReminders(); }
        
        async function loadCurrency() { try { const r = await(await fetch('https://api.exchangerate-api.com/v4/latest/MYR')).json(); document.getElementById('currencyRates').innerHTML = CURRENCIES.map(c => `<div class="list-item"><span>${c.code}</span><span style="color:var(--accent-green)">${(1/r.rates[c.code]).toFixed(3)}</span></div>`).join(''); } catch(e){} }
        async function loadNews() { document.getElementById('dashNews').textContent = "News loaded (Mock)"; } // Keeping simple to avoid CORS issues in demo
        async function generateDailyBriefing() { document.getElementById('briefingContent').textContent = "Weather looks good today. Check alerts tab for details."; }

        // ==================== 7. CHAT & MEDICAL (From V9) ====================
        const MEDICAL = { stomach: 'ğŸ¤¢ Ginger tea, avoid spicy food.', fever: 'ğŸ¤’ Drink water, Paracetamol.', head: 'ğŸ§  Rest in dark room.' };
        function sendChat() { const i = document.getElementById('chatInput'); const t = i.value.toLowerCase(); if(!t) return; addMsg(i.value, 'user'); i.value=''; setTimeout(()=>{ let r="I can help with weather, rates, or health."; if(t.includes('weath')) r="Check Weather tab."; if(t.includes('fever')||t.includes('head')) r=MEDICAL.fever; addMsg(r, 'bot'); },500); }
        function addMsg(t, type) { document.getElementById('chatMessages').innerHTML += `<div class="chat-message ${type}"><div class="chat-bubble">${t}</div></div>`; }

        // Utils
        function calcDist(lat1,lon1,lat2,lon2) { const R=6371; const dLat=(lat2-lat1)*Math.PI/180; const dLon=(lon2-lon1)*Math.PI/180; const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2; return R*2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); }
        function showToast(msg, err=false) { const t=document.getElementById('toast'); t.querySelector('.toast-message').textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2000); }
    </script>
</body>
</html>
