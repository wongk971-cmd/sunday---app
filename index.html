<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Sunday">
    <meta name="theme-color" content="#0f0f1a">
    <title>Sunday V9.1 AI</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        :root {
            /* üîµ Restore classic blue theme (V3/V5 Style) */
            --bg-primary: #0f0f1a;
            --bg-secondary: #1a1a2e;
            --bg-card: #16213e;
            
            --accent-primary: #00d4ff; /* Classic Blue */
            --accent-secondary: #7b2cbf; /* Purple Accent */
            --accent-glow: rgba(0, 212, 255, 0.5);
            
            --accent-success: #00ff88;
            --accent-danger: #ff4757;
            --accent-warning: #ff6b35;
            
            --text-primary: #ffffff;
            --text-secondary: #a0a0b0;
            --text-muted: #6b6b7b;
            
            --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --radius-md: 16px;
            --radius-lg: 24px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Outfit', -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        .bg-gradient {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: 
                radial-gradient(ellipse at 20% 20%, rgba(123, 44, 191, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(0, 212, 255, 0.1) 0%, transparent 50%);
            z-index: -1;
        }

        .app-container {
            max-width: 500px;
            margin: 0 auto;
            padding: 15px;
            padding-bottom: 100px;
        }

        /* Header */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 0;
            margin-bottom: 20px;
        }

        .logo { display: flex; align-items: center; gap: 12px; }

        .logo-icon {
            width: 48px; height: 48px;
            background: #000;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid var(--accent-primary);
            box-shadow: 0 0 15px var(--accent-glow);
            display: flex; align-items: center; justify-content: center;
            font-size: 24px;
        }
        
        .logo-icon img {
            width: 100%; height: 100%;
            object-fit: cover;
        }

        .logo-text h1 { font-size: 24px; font-weight: 700; }
        .logo-text span { font-size: 11px; color: var(--text-muted); letter-spacing: 2px; }

        .header-time { text-align: right; font-family: 'JetBrains Mono', monospace; }
        .header-time .time { font-size: 24px; font-weight: 500; color: var(--accent-primary); }
        .header-time .date { font-size: 12px; color: var(--text-secondary); }

        /* Navigation */
        .nav-tabs {
            display: flex; gap: 6px; padding: 6px;
            background: var(--glass);
            border-radius: var(--radius-lg);
            border: 1px solid var(--glass-border);
            margin-bottom: 20px;
            overflow-x: auto;
        }
        .nav-tabs::-webkit-scrollbar { display: none; }

        .nav-tab {
            flex: 1; min-width: 55px; padding: 10px 6px;
            border: none; background: transparent;
            color: var(--text-secondary);
            font-family: 'Outfit', sans-serif;
            font-size: 9px; font-weight: 500;
            border-radius: var(--radius-md);
            cursor: pointer;
            display: flex; flex-direction: column; align-items: center; gap: 3px;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
        }

        .nav-tab .icon { font-size: 18px; }

        /* Pages */
        .page { display: none; animation: fadeIn 0.3s ease-out; }
        .page.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--glass-border);
            padding: 18px;
            margin-bottom: 15px;
        }

        .card-header {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 15px;
        }

        .card-title {
            display: flex; align-items: center; gap: 10px;
            font-size: 16px; font-weight: 600;
        }

        .badge {
            padding: 5px 10px; border-radius: 15px;
            font-size: 11px; font-weight: 500;
            background: var(--glass);
        }

        .badge.live { background: rgba(255, 71, 87, 0.2); color: var(--accent-danger); animation: pulse 2s infinite; }
        .badge.tracking { background: rgba(0, 255, 136, 0.2); color: var(--accent-success); }

        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        /* Stats Grid */
        .stats-grid {
            display: grid; grid-template-columns: repeat(4, 1fr);
            gap: 8px; margin-bottom: 15px;
        }

        .stat-item {
            background: var(--glass);
            padding: 12px 8px;
            border-radius: var(--radius-md);
            text-align: center;
        }

        .stat-value { font-size: 18px; font-weight: 700; color: var(--accent-primary); }
        .stat-label { font-size: 9px; color: var(--text-muted); margin-top: 2px; }

        /* Weather */
        .weather-main { display: flex; align-items: center; gap: 20px; padding: 10px 0; }
        .weather-icon { font-size: 50px; }
        .weather-temp { font-size: 38px; font-weight: 700; }
        .weather-condition { color: var(--text-secondary); font-size: 14px; }

        .weather-details {
            display: grid; grid-template-columns: repeat(3, 1fr);
            gap: 10px; margin-top: 15px;
        }

        .weather-detail {
            background: var(--glass);
            padding: 12px; border-radius: var(--radius-md);
            text-align: center;
        }

        .weather-detail .value { font-size: 16px; font-weight: 600; color: var(--accent-primary); }
        .weather-detail .label { font-size: 10px; color: var(--text-muted); }

        /* Location List */
        .location-list { display: flex; flex-direction: column; gap: 8px; }

        .location-card {
            background: var(--glass);
            padding: 12px; border-radius: var(--radius-md);
            display: flex; align-items: center; justify-content: space-between;
            cursor: pointer;
        }

        .location-info { display: flex; align-items: center; gap: 10px; }
        .location-name { font-weight: 500; font-size: 14px; }
        .location-temp { font-size: 18px; font-weight: 600; color: var(--accent-primary); }

        /* Input & Buttons */
        .input-group { position: relative; margin-bottom: 12px; }

        .input-field {
            width: 100%; padding: 14px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-family: 'Outfit', sans-serif;
            font-size: 15px;
        }

        .input-field:focus { outline: none; border-color: var(--accent-primary); }

        /* Search Results */
        .search-results {
            position: absolute;
            top: 100%; left: 0; right: 0;
            background: var(--bg-card);
            border: 1px solid var(--accent-primary);
            border-radius: var(--radius-md);
            margin-top: 5px;
            z-index: 3000;
            max-height: 250px;
            overflow-y: auto;
            display: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }
        .search-results.active { display: block; animation: slideDown 0.2s ease-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .search-item {
            padding: 12px 15px;
            border-bottom: 1px solid var(--glass-border);
            cursor: pointer;
            transition: background 0.2s;
        }
        .search-item:last-child { border-bottom: none; }
        .search-item:hover { background: var(--glass); }
        .search-item-name { font-weight: 500; font-size: 14px; color: var(--text-primary); }
        .search-item-detail { font-size: 11px; color: var(--accent-primary); margin-top: 2px; }

        .btn {
            padding: 14px 24px; border: none;
            border-radius: var(--radius-md);
            font-family: 'Outfit', sans-serif;
            font-size: 14px; font-weight: 500;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            width: 100%;
        }

        .btn-primary { background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); color: white; }
        .btn-secondary { background: var(--glass); color: var(--text-primary); border: 1px solid var(--glass-border); }
        .btn-danger { background: linear-gradient(135deg, var(--accent-danger), #ff6b6b); color: white; }
        .btn-success { background: linear-gradient(135deg, var(--accent-success), #00d68f); color: #0f0f1a; }

        .btn-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
        .btn-sm { padding: 10px 16px; font-size: 12px; }

        /* Map & Tracking Styles */
        .map-small-container {
            width: 100%; height: 200px;
            border-radius: var(--radius-md);
            overflow: hidden; margin-bottom: 15px;
            position: relative; cursor: pointer;
        }
        #journeyMapSmall, #parkingMap { width: 100%; height: 100%; }
        .map-fullscreen {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            z-index: 2000; background: var(--bg-primary);
            display: none;
        }
        .map-fullscreen.active { display: block; }
        #journeyMapFull { width: 100%; height: 100%; }

        .map-top-bar {
            position: absolute; top: 0; left: 0; right: 0;
            background: linear-gradient(180deg, rgba(15, 15, 26, 0.95) 0%, transparent 100%);
            padding: 50px 20px 40px; z-index: 2001;
        }
        .map-status-row { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        .map-mode-icon {
            width: 50px; height: 50px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 24px; box-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
        }
        .map-mode-info { flex: 1; }
        .map-mode-title { font-size: 20px; font-weight: 700; }
        .map-street { font-size: 13px; color: var(--text-secondary); margin-top: 3px; }
        .map-close-btn { width: 40px; height: 40px; background: var(--glass); border: none; border-radius: 50%; color: white; font-size: 20px; cursor: pointer; }
        
        .map-live-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .map-stat { text-align: center; background: rgba(0, 0, 0, 0.3); padding: 10px 5px; border-radius: 12px; backdrop-filter: blur(10px); }
        .map-stat .value { font-size: 18px; font-weight: 700; color: var(--accent-primary); font-family: 'JetBrains Mono', monospace; }
        .map-stat .label { font-size: 9px; color: var(--text-muted); }

        .map-bottom-bar {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: linear-gradient(0deg, rgba(15, 15, 26, 0.98) 0%, transparent 100%);
            padding: 40px 20px 40px; z-index: 2001;
        }
        .map-duration { text-align: center; margin-bottom: 20px; }
        .map-duration-time { font-size: 36px; font-weight: 700; color: var(--accent-success); font-family: 'JetBrains Mono', monospace; }
        .map-controls { display: flex; gap: 15px; justify-content: center; align-items: center; }
        .map-btn { width: 55px; height: 55px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; font-size: 22px; cursor: pointer; background: rgba(255, 255, 255, 0.1); color: white; backdrop-filter: blur(10px); }
        .map-btn-end { width: 70px; height: 70px; background: linear-gradient(135deg, var(--accent-danger), #ff6b6b); font-size: 28px; box-shadow: 0 0 30px rgba(255, 71, 87, 0.5); }

        /* Timeline & History */
        .timeline-panel {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: var(--bg-card); border-radius: 24px 24px 0 0;
            max-height: 50%; z-index: 2002; transform: translateY(100%); transition: transform 0.3s ease;
        }
        .timeline-panel.show { transform: translateY(0); }
        .timeline-header { padding: 15px 20px; border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center; }
        .timeline-content { padding: 20px; max-height: calc(50vh - 60px); overflow-y: auto; }
        
        .history-card { background: var(--glass); border-radius: var(--radius-md); padding: 15px; margin-bottom: 10px; cursor: pointer; }
        .history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .history-stats { display: flex; gap: 15px; flex-wrap: wrap; }
        .history-stat span { color: var(--text-primary); font-weight: 600; }

        /* Chat */
        .chat-messages {
            height: 350px; overflow-y: auto;
            padding: 15px; background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            margin-bottom: 12px;
        }
        .chat-message { margin-bottom: 12px; }
        .chat-message.user { text-align: right; }
        .chat-bubble {
            display: inline-block; max-width: 85%;
            padding: 10px 14px;
            border-radius: var(--radius-md);
            font-size: 13px;
        }
        .chat-message.user .chat-bubble {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
        }
        .chat-message.bot .chat-bubble { background: var(--glass); }
        .chat-input-area { display: flex; gap: 10px; }
        .chat-input-area .btn { width: auto; padding: 14px 18px; }
        
        /* Loading Spinner */
        .loading { display: flex; justify-content: center; padding: 30px; }
        .spinner {
            width: 30px; height: 30px; border: 3px solid var(--glass);
            border-top-color: var(--accent-primary); border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Alerts & Toast */
        .toast {
            position: fixed; top: 20px; left: 20px; right: 20px;
            padding: 14px 18px; background: var(--bg-card);
            border: 1px solid var(--accent-success); border-radius: var(--radius-md);
            z-index: 5000; display: flex; align-items: center; gap: 10px;
            transform: translateY(-150%); transition: transform 0.4s ease;
        }
        .toast.show { transform: translateY(0); }
        .toast.error { border-color: var(--accent-danger); }

        .alert-card {
            padding: 12px; border-radius: var(--radius-md);
            margin-bottom: 10px; border-left: 4px solid;
            background: var(--glass);
        }
        .alert-card.danger { background: rgba(255, 71, 87, 0.1); border-color: var(--accent-danger); }
        .alert-card.warning { background: rgba(255, 165, 0, 0.1); border-color: var(--accent-warning); }
        .alert-card.info { background: rgba(0, 212, 255, 0.1); border-color: var(--accent-primary); }
        
        /* Briefing */
        .briefing-card {
            border-left: 3px solid var(--accent-primary);
            background: rgba(0, 212, 255, 0.05);
            margin-bottom: 15px; padding: 12px; border-radius: var(--radius-md);
        }
        .briefing-row { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 4px; border-bottom: 1px solid rgba(255,255,255,0.05); }

        .reminder-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--glass); border-radius: var(--radius-md); margin-bottom: 10px; }
        .reminder-content { flex: 1; }
        .reminder-delete { background: none; border: none; color: var(--text-muted); cursor: pointer; }

        .modal {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.8); z-index: 4000;
            display: none; align-items: center; justify-content: center; padding: 20px;
        }
        .modal.show { display: flex; }
        .modal-content { background: var(--bg-card); border-radius: var(--radius-lg); width: 100%; max-width: 400px; max-height: 80vh; overflow-y: auto; }
        .modal-header { padding: 20px; border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; }
        .fitness-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin: 15px 0; }
        .fitness-item { background: var(--glass); padding: 15px; border-radius: var(--radius-md); text-align: center; }

        /* Date Picker Glass Style */
        .date-picker-glass {
            background: rgba(255,255,255,0.1);
            border: 1px solid var(--glass-border);
            color: white;
            padding: 5px 10px;
            border-radius: 8px;
            font-family: 'Outfit', sans-serif;
            font-size: 12px;
            color-scheme: dark;
            outline: none;
        }

    </style>
</head>
<body>
    <div class="bg-gradient"></div>

    <div class="app-container">
        <header class="header">
            <div class="logo">
                <div class="logo-icon">S</div>
                <div class="logo-text">
                    <h1>Sunday</h1>
                    <span>AI ASSISTANT V9.1</span>
                </div>
            </div>
            <div class="header-time">
                <div class="time" id="currentTime">00:00</div>
                <div class="date" id="currentDate">Loading...</div>
            </div>
        </header>

        <nav class="nav-tabs">
            <button class="nav-tab active" data-page="dashboard"><span class="icon">üè†</span><span>Home</span></button>
            <button class="nav-tab" data-page="weather"><span class="icon">üå§Ô∏è</span><span>Weather</span></button>
            <button class="nav-tab" data-page="journey"><span class="icon">üó∫Ô∏è</span><span>Journey</span></button>
            <button class="nav-tab" data-page="parking"><span class="icon">üÖøÔ∏è</span><span>Parking</span></button>
            <button class="nav-tab" data-page="tools"><span class="icon">üõ†Ô∏è</span><span>Tools</span></button>
            <button class="nav-tab" data-page="alerts"><span class="icon">üö®</span><span>Alerts</span></button>
            <button class="nav-tab" data-page="chat"><span class="icon">üí¨</span><span>Chat</span></button>
        </nav>

        <div class="page active" id="page-dashboard">
            <div id="dailyBriefing" class="briefing-card" style="display:none">
                <div class="briefing-title">üîî Morning Update</div>
                <div id="briefingContent"></div>
            </div>

            <div class="stats-grid">
                <div class="stat-item"><div class="stat-value" id="dashTemp">--¬∞</div><div class="stat-label">Temp</div></div>
                <div class="stat-item"><div class="stat-value" id="dashAlerts">0</div><div class="stat-label">Alerts</div></div>
                <div class="stat-item"><div class="stat-value" id="dashJourneys">0</div><div class="stat-label">Journeys</div></div>
                <div class="stat-item"><div class="stat-value" id="dashReminders">0</div><div class="stat-label">Reminders</div></div>
            </div>

            <div class="card">
                <div class="card-header"><div class="card-title">üå§Ô∏è Weather</div><span class="badge live">‚óè LIVE</span></div>
                <div class="weather-main" id="dashWeather">
                    <div class="weather-icon">‚òÄÔ∏è</div>
                    <div><div class="weather-temp">--¬∞C</div><div class="weather-condition">Loading...</div></div>
                </div>
            </div>

            <div class="card">
                <div class="card-header"><div class="card-title">üö® Recent Alerts</div></div>
                <div id="dashAlertsPreview"></div>
            </div>

            <div class="card">
                <div class="card-header"><div class="card-title">üì∞ News</div></div>
                <div id="dashNews"><div class="loading"><div class="spinner"></div></div></div>
            </div>
        </div>

        <div class="page" id="page-weather">
            <div class="input-group">
                <input type="text" class="input-field" id="weatherSearch" placeholder="üîç Search city (e.g. London)..." autocomplete="off">
                <div id="searchResults" class="search-results"></div>
            </div>
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üìç <span id="weatherLocation">Johor Jaya</span></div>
                    <span class="badge live">‚óè LIVE</span>
                </div>
                <div class="weather-main">
                    <div class="weather-icon" id="weatherIcon">‚òÄÔ∏è</div>
                    <div><div class="weather-temp"><span id="weatherTemp">--</span>¬∞C</div><div class="weather-condition" id="weatherCondition">Loading...</div></div>
                </div>
                <div class="weather-details">
                    <div class="weather-detail"><div class="value" id="weatherWind">--</div><div class="label">Wind</div></div>
                    <div class="weather-detail"><div class="value" id="weatherHumidity">--</div><div class="label">Humidity</div></div>
                    <div class="weather-detail"><div class="value" id="weatherRain">--</div><div class="label">Rain %</div></div>
                </div>
            </div>
            <div class="card">
                <div class="card-header"><div class="card-title">üåç Locations</div></div>
                <div class="location-list" id="monitoredLocations"><div class="loading"><div class="spinner"></div></div></div>
            </div>
        </div>

        <div class="page" id="page-journey">
            <div class="card" id="activeJourneyCard" style="display: none;">
                <div class="card-header">
                    <div class="card-title">üöó <span id="journeyModeText">Tracking</span></div>
                    <span class="badge tracking">‚óè LIVE</span>
                </div>
                <div class="stats-grid" style="margin-top: 15px; grid-template-columns: repeat(3, 1fr);">
                    <div class="stat-item"><div class="stat-value" id="jDistance">0.0</div><div class="stat-label">km</div></div>
                    <div class="stat-item"><div class="stat-value" id="jSpeed">0</div><div class="stat-label">km/h</div></div>
                    <div class="stat-item"><div class="stat-value" id="jTime">0</div><div class="stat-label">min</div></div>
                    <div class="stat-item"><div class="stat-value" id="jCalories">0</div><div class="stat-label">kcal</div></div>
                </div>
                <div class="map-small-container" onclick="openFullscreenMap()">
                    <div id="journeyMapSmall"></div>
                </div>
                <div class="btn-row">
                    <button class="btn btn-secondary" onclick="openFullscreenMap()">üó∫Ô∏è Full Map</button>
                    <button class="btn btn-danger" onclick="endJourney()">üèÅ End</button>
                </div>
            </div>

            <div class="card" id="startJourneyCard">
                <div class="card-header"><div class="card-title">üöÄ Start Journey</div></div>
                <div style="text-align:center; padding:20px; color:var(--text-muted);">
                    <div style="font-size:30px; margin-bottom:10px;">üó∫Ô∏è</div>
                    GPS Tracking + Auto Mode
                </div>
                <button class="btn btn-primary" onclick="startJourney()">üìç Start Journey</button>
            </div>

            <div class="card">
                <div class="card-header"><div class="card-title">üìú History</div></div>
                <div id="journeyHistory"></div>
            </div>
        </div>

        <div class="page" id="page-parking">
            <div class="card">
                <div class="card-header"><div class="card-title">üöó My Car</div></div>
                <div id="parkingDisplay" style="text-align:center; padding:20px;">No location saved</div>
                <div class="map-small-container" id="parkingMapContainer" style="display: none;"><div id="parkingMap"></div></div>
                <div class="btn-row-3">
                    <button class="btn btn-primary btn-sm" onclick="saveParking('gps')">üìç GPS</button>
                    <button class="btn btn-secondary btn-sm" onclick="document.getElementById('photoInput').click()">üì∏ Photo</button>
                    <button class="btn btn-secondary btn-sm" onclick="saveParking('both')">üìç+üì∏</button>
                </div>
                <input type="file" id="photoInput" accept="image/*" capture="environment" style="display:none" onchange="handlePhoto(event)">
            </div>
            <div class="card">
                <div class="card-header"><div class="card-title">‚≠ê Saved Places</div></div>
                <div class="input-group"><input type="text" class="input-field" id="customPlaceName" placeholder="Name this place"></div>
                <button class="btn btn-secondary" onclick="saveCustomPlace()">üíæ Save Place</button>
                <div id="customPlacesList" style="margin-top: 15px;"></div>
            </div>
        </div>

        <div class="page" id="page-tools">
            <div class="card">
                <div class="card-header"><div class="card-title">‚è∞ Reminders</div><span class="badge" id="reminderBadge">0</span></div>
                <div class="input-group"><input type="text" class="input-field" id="reminderTask" placeholder="What to remind?"></div>
                <div class="btn-row" style="margin-bottom: 15px;">
                    <select class="input-field" id="reminderTime">
                        <option value="10">10 mins</option>
                        <option value="30">30 mins</option>
                        <option value="60">1 hour</option>
                    </select>
                    <button class="btn btn-primary" onclick="addReminder()">‚è∞ Set</button>
                </div>
                <div id="reminderList"></div>
            </div>
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üí± Currency (vs MYR)</div>
                    <input type="date" id="currencyDate" class="date-picker-glass" onchange="loadCurrency(this.value)">
                </div>
                <div id="currencyRates"><div class="loading"><div class="spinner"></div></div></div>
            </div>
        </div>

        <div class="page" id="page-alerts">
            <div class="card">
                <div class="card-header"><div class="card-title">üåç Global Weather Watch</div></div>
                <div id="globalWeatherAlerts"><div class="loading"><div class="spinner"></div></div></div>
            </div>
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üö® Earthquake Monitor</div>
                    <input type="date" id="quakeDate" class="date-picker-glass" onchange="loadEarthquakes(this.value)">
                </div>
                <div id="earthquakeAlerts"><div class="loading"><div class="spinner"></div></div></div>
            </div>
        </div>

        <div class="page" id="page-chat">
            <div class="card">
                <div class="card-header"><div class="card-title">üí¨ Chat AI</div></div>
                <div id="chatBriefing" class="briefing-card" style="display:none; margin: 15px;">
                    <div class="briefing-title">üîî Morning Update</div>
                    <div id="chatBriefingContent"></div>
                </div>
                <div class="chat-messages" id="chatMessages">
                    <div class="chat-message bot"><div class="chat-bubble">Hi! I'm Sunday AI. I can check weather, set reminders, and answer questions. Try using the microphone! üéôÔ∏è</div></div>
                </div>
                <div class="chat-input-area">
                    <button class="btn btn-secondary" onclick="startListening()" style="min-width: 50px; font-size: 18px;">üéôÔ∏è</button>
                    <input type="text" class="input-field" id="chatInput" placeholder="Type or ask Sunday..." onkeypress="if(event.key==='Enter')sendChat()">
                    <button class="btn btn-primary" onclick="sendChat()">‚û§</button>
                </div>
            </div>
        </div>
    </div>

    <div class="map-fullscreen" id="mapFullscreen">
        <div id="journeyMapFull"></div>
        <div class="map-top-bar">
            <div class="map-status-row">
                <div class="map-mode-icon" id="fsModeIcon">üö∂</div>
                <div class="map-mode-info">
                    <div class="map-mode-title" id="fsModeTitle">Walking</div>
                    <div class="map-street" id="fsStreet">Detecting location...</div>
                </div>
                <button class="map-close-btn" onclick="closeFullscreenMap()">‚úï</button>
            </div>
            <div class="map-live-stats" style="grid-template-columns: repeat(3, 1fr);">
                <div class="map-stat"><div class="value" id="fsDistance">0.0</div><div class="label">km</div></div>
                <div class="map-stat"><div class="value" id="fsSpeed">0</div><div class="label">km/h</div></div>
                <div class="map-stat"><div class="value" id="fsTime">0</div><div class="label">min</div></div>
            </div>
        </div>
        <div class="map-bottom-bar">
            <div class="map-duration">
                <div class="map-duration-label">Duration</div>
                <div class="map-duration-time" id="fsDuration">00:00</div>
            </div>
            <div class="map-controls">
                <button class="map-btn map-btn-end" onclick="endJourney()">üèÅ</button>
                <button class="map-btn" onclick="centerMapOnUser()">üìç</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"><span class="toast-icon">‚úÖ</span><span class="toast-message">Success!</span></div>
    <div class="modal" id="historyModal">
        <div class="modal-content">
            <div class="modal-header"><div class="modal-title">üìú Journey Details</div><button class="modal-close" onclick="closeModal()">√ó</button></div>
            <div class="modal-body" id="historyModalBody"></div>
        </div>
    </div>

    <script>
        // ================= AI CONFIGURATION (üî¥ REQUIRED) =================
        // ËØ∑Âú®ËøôÈáåÂ°´ÂÖ•‰Ω†ÁöÑ Google Gemini API Key
        const GEMINI_API_KEY = ""; 

        const APP = { journey: null, watchId: null, mapSmall: null, mapFull: null, markerSmall: null, markerFull: null, pathSmall: null, pathFull: null, pathCoords: [], parkingMap: null, reminders: [], parking: null, customPlaces: {}, journeyHistory: [], pendingPhoto: null, timerInterval: null, isFullscreen: false };
        const LOCATIONS = { 'Johor Jaya': { lat: 1.5360, lon: 103.7930 }, 'Iskandar Puteri': { lat: 1.4190, lon: 103.6350 }, 'Singapore': { lat: 1.3521, lon: 103.8198 }, 'Tokyo': { lat: 35.6895, lon: 139.6917 }, 'London': { lat: 51.5074, lon: -0.1278 } };
        const GLOBAL_MONITOR = [{n:'Tokyo', lat:35.6895, lon:139.6917}, {n:'New York', lat:40.7128, lon:-74.0060}, {n:'London', lat:51.5074, lon:-0.1278}, {n:'Dubai', lat:25.2769, lon:55.2962}, {n:'Singapore', lat:1.3521, lon:103.8198}];
        const CURRENCIES = [{ code: 'USD', flag: 'üá∫üá∏' }, { code: 'SGD', flag: 'üá∏üá¨' }, { code: 'EUR', flag: 'üá™üá∫' }, { code: 'GBP', flag: 'üá¨üáß' }, { code: 'JPY', flag: 'üáØüáµ' }, { code: 'CNY', flag: 'üá®üá≥' }];

        document.addEventListener('DOMContentLoaded', () => {
            loadStorage(); initNav(); updateClock(); setInterval(updateClock, 1000);
            loadWeather(); loadNews(); 
            loadCurrency(); // Default today
            loadEarthquakes(); // Default today
            loadGlobalWeatherAlerts();
            renderReminders(); renderParking(); renderHistory(); renderPlaces(); generateDailyBriefing();
            setInterval(checkReminders, 10000); 
            if ('Notification' in window) Notification.requestPermission();
        });

        // ================= CORE FUNCTIONS =================
        function loadStorage() { try { APP.reminders = JSON.parse(localStorage.getItem('sun_rem') || '[]'); APP.parking = JSON.parse(localStorage.getItem('sun_park') || 'null'); APP.customPlaces = JSON.parse(localStorage.getItem('sun_places') || '{}'); APP.journeyHistory = JSON.parse(localStorage.getItem('sun_hist') || '[]'); } catch(e) {} }
        function saveStorage() { localStorage.setItem('sun_rem', JSON.stringify(APP.reminders)); localStorage.setItem('sun_park', JSON.stringify(APP.parking)); localStorage.setItem('sun_places', JSON.stringify(APP.customPlaces)); localStorage.setItem('sun_hist', JSON.stringify(APP.journeyHistory)); }
        function initNav() { document.querySelectorAll('.nav-tab').forEach(t => t.addEventListener('click', () => { document.querySelectorAll('.nav-tab').forEach(x => x.classList.remove('active')); document.querySelectorAll('.page').forEach(x => x.classList.remove('active')); t.classList.add('active'); document.getElementById('page-' + t.dataset.page).classList.add('active'); })); }
        function updateClock() { const now = new Date(); document.getElementById('currentTime').textContent = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false }); document.getElementById('currentDate').textContent = now.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }); }
        
        // ================= WEATHER & API =================
        async function loadWeather() { await updateWeather('Johor Jaya', 1.536, 103.793); const container = document.getElementById('monitoredLocations'); container.innerHTML = ''; for (const [n, c] of Object.entries(LOCATIONS)) { try { const d = await (await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${c.lat}&longitude=${c.lon}&current=temperature_2m,weather_code`)).json(); const cond = getWeatherCond(d.current.weather_code); container.innerHTML += `<div class="location-card" onclick="updateWeather('${n}',${c.lat},${c.lon})"><div class="location-info"><span style="font-size:20px">${cond.icon}</span><span class="location-name">${n}</span></div><span class="location-temp">${Math.round(d.current.temperature_2m)}¬∞</span></div>`; } catch(e) {} } }
        async function updateWeather(name, lat, lon) {
            try {
                if (lat === 0 && lon === 0) {
                    const search = await (await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${name}&count=1`)).json();
                    if(search.results) { lat = search.results[0].latitude; lon = search.results[0].longitude; name = search.results[0].name; }
                }
                const d = await (await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code,wind_speed_10m,relative_humidity_2m&hourly=precipitation_probability`)).json();
                const temp = Math.round(d.current.temperature_2m); const cond = getWeatherCond(d.current.weather_code);
                document.getElementById('weatherLocation').textContent = name; document.getElementById('weatherTemp').textContent = temp; document.getElementById('weatherIcon').textContent = cond.icon; document.getElementById('weatherCondition').textContent = cond.text; document.getElementById('weatherWind').textContent = Math.round(d.current.wind_speed_10m); document.getElementById('weatherHumidity').textContent = d.current.relative_humidity_2m; document.getElementById('weatherRain').textContent = d.hourly.precipitation_probability[0] || 0; document.getElementById('dashTemp').textContent = temp + '¬∞'; document.getElementById('dashWeather').innerHTML = `<div class="weather-icon">${cond.icon}</div><div><div class="weather-temp">${temp}¬∞C</div><div class="weather-condition">${name}</div></div>`;
                return `The weather in ${name} is ${cond.text}, ${temp}¬∞C.`;
            } catch(e) { return 'Could not fetch weather.'; }
        }
        function getWeatherCond(code) { if (code === 0) return { icon: '‚òÄÔ∏è', text: 'Clear' }; if (code <= 3) return { icon: '‚õÖ', text: 'Cloudy' }; if (code >= 95) return { icon: '‚õàÔ∏è', text: 'Storm' }; if (code >= 61) return { icon: 'üåßÔ∏è', text: 'Rain' }; if (code >= 51) return { icon: 'üå¶Ô∏è', text: 'Drizzle' }; if (code >= 71) return { icon: '‚ùÑÔ∏è', text: 'Snow' }; return { icon: '‚òÅÔ∏è', text: 'Cloudy' }; }

        // ================= SMART SEARCH =================
        const searchInput = document.getElementById('weatherSearch'); const searchResults = document.getElementById('searchResults');
        searchInput.addEventListener('keyup', async (e) => { if (e.key === 'Enter') { const query = e.target.value.trim(); if (!query) return; searchResults.innerHTML = '<div class="search-item">Searching...</div>'; searchResults.classList.add('active'); try { const r = await (await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(query)}&count=5&language=en&format=json`)).json(); if (!r.results) { searchResults.innerHTML = '<div class="search-item">No results</div>'; } else { searchResults.innerHTML = r.results.map(item => `<div class="search-item" onclick="updateWeather('${item.name}', ${item.latitude}, ${item.longitude});searchResults.classList.remove('active')"><div class="search-item-name">${item.name}, ${item.country || ''}</div></div>`).join(''); } } catch(err) { searchResults.classList.remove('active'); } } });
        document.addEventListener('click', (e) => { if (!e.target.closest('.input-group')) searchResults.classList.remove('active'); });

        // ================= ALERTS & EARTHQUAKE =================
        async function loadGlobalWeatherAlerts() { const container = document.getElementById('globalWeatherAlerts'); let html = ''; for (const city of GLOBAL_MONITOR) { try { const d = await (await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${city.lat}&longitude=${city.lon}&current=weather_code`)).json(); if ([95,96,99].includes(d.current.weather_code)) html += `<div class="alert-card danger"><div class="alert-header"><div class="alert-title">üö® ${city.n}</div></div><div class="alert-body">Severe Thunderstorm</div></div>`; } catch(e){} } container.innerHTML = html || '<div class="alert-card info"><div class="alert-body">‚úÖ No global severe alerts.</div></div>'; }
        
        async function loadEarthquakes(dateStr) { 
            const container = document.getElementById('earthquakeAlerts');
            container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            if (!dateStr) { const now = new Date(); const offset = now.getTimezoneOffset() * 60000; dateStr = new Date(now.getTime() - offset).toISOString().split('T')[0]; document.getElementById('quakeDate').value = dateStr; }
            const start = dateStr; const startDate = new Date(dateStr); const nextDay = new Date(startDate); nextDay.setDate(startDate.getDate() + 1); const end = nextDay.toISOString().split('T')[0];
            const isToday = (new Date().toISOString().split('T')[0] === start);
            try {
                const url = `https://earthquake.usgs.gov/fdsnws/event/1/query?format=geojson&starttime=${start}&endtime=${end}&minmagnitude=4.5&orderby=time&limit=20`;
                const quakes = (await (await fetch(url)).json()).features; 
                if (isToday) document.getElementById('dashAlerts').textContent = quakes.length;
                if(!quakes.length) { container.innerHTML = `<div class="alert-card info"><div class="alert-title">‚úÖ No earthquakes >M4.5 on ${start}</div></div>`; return; } 
                container.innerHTML = quakes.map(q => `<div class="alert-card ${q.properties.mag >= 6 ? 'danger' : 'warning'}"><div class="alert-header"><div class="alert-title">${q.properties.mag >= 6 ? 'üö®' : 'üåç'} M${q.properties.mag.toFixed(1)}</div><div class="alert-time">${new Date(q.properties.time).toLocaleTimeString()}</div></div><div class="alert-body">üìç ${q.properties.place}</div></div>`).join(''); 
            } catch(e) { container.innerHTML = '<div class="alert-card danger">Error loading data</div>'; } 
        }

        async function generateDailyBriefing() { let content = ''; for (const [n, c] of Object.entries(LOCATIONS)) { if(n === 'London') break; try { const d = await (await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${c.lat}&longitude=${c.lon}&current=temperature_2m,weather_code`)).json(); content += `<div class="briefing-row"><span>‚Ä¢ ${n}</span><span>${getWeatherCond(d.current.weather_code).icon} ${d.current.temperature_2m}¬∞C</span></div>`; } catch(e) {} } try { const r = await (await fetch('https://api.exchangerate-api.com/v4/latest/SGD')).json(); content += `<div class="briefing-row"><span>SGD 1 ‚âà RM ${(r.rates.MYR).toFixed(2)}</span></div>`; } catch(e) {} document.getElementById('briefingContent').innerHTML = content; document.getElementById('chatBriefingContent').innerHTML = content; document.getElementById('dailyBriefing').style.display = 'block'; document.getElementById('chatBriefing').style.display = 'block'; }

        // ================= JOURNEY & TRACKING =================
        function startJourney() { if (!navigator.geolocation) return showToast('GPS not supported', true); navigator.geolocation.getCurrentPosition(pos => { const lat = pos.coords.latitude, lon = pos.coords.longitude; APP.journey = { startTime: Date.now(), lastLat: lat, lastLon: lon, lastTime: Date.now(), totalKm: 0, calories: 0, speed: 0, mode: 'walking', currentAlt: pos.coords.altitude || 0 }; APP.pathCoords = [[lat, lon]]; document.getElementById('startJourneyCard').style.display = 'none'; document.getElementById('activeJourneyCard').style.display = 'block'; setTimeout(() => { APP.mapSmall = L.map('journeyMapSmall', { zoomControl: false, attributionControl: false }).setView([lat, lon], 17); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(APP.mapSmall); APP.markerSmall = L.marker([lat, lon]).addTo(APP.mapSmall); APP.pathSmall = L.polyline(APP.pathCoords, { color: '#4285F4', weight: 4 }).addTo(APP.mapSmall); }, 100); APP.watchId = navigator.geolocation.watchPosition(trackPosition, null, { enableHighAccuracy: true }); APP.timerInterval = setInterval(updateTimer, 1000); showToast('Journey started! üöó'); }, err => showToast('GPS Error', true)); }
        function trackPosition(pos) { if (!APP.journey) return; const lat = pos.coords.latitude, lon = pos.coords.longitude; const now = Date.now(); const dist = calcDist(APP.journey.lastLat, APP.journey.lastLon, lat, lon); const timeDiff = (now - APP.journey.lastTime) / 1000 / 3600; let speed = timeDiff > 0 ? dist / timeDiff : 0; if (speed > 300) speed = APP.journey.speed; APP.journey.speed = speed; APP.journey.mode = speed > 15 ? 'driving' : 'walking'; APP.pathCoords.push([lat, lon]); if (APP.mapSmall) { APP.markerSmall.setLatLng([lat, lon]); APP.pathSmall.setLatLngs(APP.pathCoords); APP.mapSmall.panTo([lat, lon]); } if (APP.isFullscreen && APP.mapFull) { APP.markerFull.setLatLng([lat, lon]); APP.pathFull.setLatLngs(APP.pathCoords); APP.mapFull.panTo([lat, lon]); } if (dist > 0.005) { APP.journey.totalKm += dist; if (APP.journey.mode === 'walking') APP.journey.calories += dist * 65; APP.journey.lastLat = lat; APP.journey.lastLon = lon; APP.journey.lastTime = now; getStreetName(lat, lon); } updateJourneyUI(); }
        function updateJourneyUI() { const j = APP.journey; document.getElementById('jDistance').textContent = j.totalKm.toFixed(2); document.getElementById('jSpeed').textContent = j.speed.toFixed(1); document.getElementById('jCalories').textContent = Math.round(j.calories); document.getElementById('journeyModeText').textContent = j.mode === 'driving' ? 'Driving' : 'Walking'; document.getElementById('fsDistance').textContent = j.totalKm.toFixed(2); document.getElementById('fsSpeed').textContent = j.speed.toFixed(1); }
        function updateTimer() { if (!APP.journey) return; const secs = Math.floor((Date.now() - APP.journey.startTime) / 1000); const mins = Math.floor(secs / 60); document.getElementById('jTime').textContent = mins; document.getElementById('fsTime').textContent = mins; document.getElementById('fsDuration').textContent = `${mins}:${(secs%60).toString().padStart(2,'0')}`; }
        async function getStreetName(lat, lon) { try { const d = await (await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18`)).json(); document.getElementById('fsStreet').textContent = d.address?.road || 'Unknown St'; } catch(e) {} }
        function calcDist(lat1, lon1, lat2, lon2) { const R = 6371, dLat = (lat2-lat1)*Math.PI/180, dLon = (lon2-lon1)*Math.PI/180; const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2; return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); }
        function openFullscreenMap() { if (!APP.journey) return; APP.isFullscreen = true; document.getElementById('mapFullscreen').classList.add('active'); setTimeout(() => { if (APP.mapFull) APP.mapFull.remove(); APP.mapFull = L.map('journeyMapFull', { zoomControl: false }).setView([APP.journey.lastLat, APP.journey.lastLon], 17); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(APP.mapFull); APP.markerFull = L.marker([APP.journey.lastLat, APP.journey.lastLon]).addTo(APP.mapFull); APP.pathFull = L.polyline(APP.pathCoords, { color: '#4285F4', weight: 5 }).addTo(APP.mapFull); }, 100); }
        function closeFullscreenMap() { APP.isFullscreen = false; document.getElementById('mapFullscreen').classList.remove('active'); }
        function centerMapOnUser() { if (APP.journey && APP.mapFull) APP.mapFull.setView([APP.journey.lastLat, APP.journey.lastLon], 17); }
        function endJourney() { if (!APP.journey) return; if (APP.watchId) navigator.geolocation.clearWatch(APP.watchId); clearInterval(APP.timerInterval); APP.journeyHistory.unshift({ id: Date.now(), date: new Date().toISOString(), distance: parseFloat(APP.journey.totalKm.toFixed(2)), duration: Math.floor((Date.now()-APP.journey.startTime)/60000), calories: Math.round(APP.journey.calories), mode: APP.journey.mode }); saveStorage(); APP.journey = null; APP.pathCoords = []; APP.isFullscreen = false; document.getElementById('mapFullscreen').classList.remove('active'); document.getElementById('activeJourneyCard').style.display = 'none'; document.getElementById('startJourneyCard').style.display = 'block'; renderHistory(); showToast('Journey saved!'); }
        function renderHistory() { const c = document.getElementById('journeyHistory'); document.getElementById('dashJourneys').textContent = APP.journeyHistory.length; c.innerHTML = APP.journeyHistory.slice(0, 5).map(j => `<div class="history-card"><div class="history-header"><span class="history-date">${new Date(j.date).toLocaleDateString()}</span><span>${j.mode==='driving'?'üöó':'üö∂'}</span></div><div class="history-stats"><div class="history-stat">üìè ${j.distance}km</div><div class="history-stat">‚è±Ô∏è ${j.duration}m</div><div class="history-stat">üî• ${j.calories}</div></div></div>`).join('') || '<div style="text-align:center;color:var(--text-muted)">No journeys yet</div>'; }

        // ================= PARKING & TOOLS =================
        function handlePhoto(e) { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = ev => { APP.pendingPhoto = ev.target.result; if (APP.pendingSaveMode === 'both') completeBothSave(); else { APP.parking = { type: 'photo', photo: APP.pendingPhoto, time: Date.now() }; saveStorage(); renderParking(); showToast('Photo saved! üì∏'); } }; reader.readAsDataURL(file); }
        function saveParking(type) { APP.pendingSaveMode = type; if (type === 'photo') { document.getElementById('photoInput').click(); return; } navigator.geolocation.getCurrentPosition(pos => { if (type === 'gps') { APP.parking = { type: 'gps', lat: pos.coords.latitude, lon: pos.coords.longitude, time: Date.now() }; saveStorage(); renderParking(); showToast('GPS saved! üÖøÔ∏è'); } else { APP.pendingGPS = { lat: pos.coords.latitude, lon: pos.coords.longitude }; document.getElementById('photoInput').click(); } }, err => showToast('GPS Error', true)); }
        function completeBothSave() { APP.parking = { type: 'both', lat: APP.pendingGPS.lat, lon: APP.pendingGPS.lon, photo: APP.pendingPhoto, time: Date.now() }; saveStorage(); renderParking(); showToast('GPS + Photo saved!'); }
        function renderParking() { const c = document.getElementById('parkingDisplay'); const mc = document.getElementById('parkingMapContainer'); if (!APP.parking) { c.innerHTML = '<div style="font-size:14px;">No location saved</div>'; mc.style.display = 'none'; return; } let html = ''; if (APP.parking.photo) html += `<img src="${APP.parking.photo}" style="max-width:100%;border-radius:10px;margin-bottom:10px">`; html += `<div style="font-weight:600">${APP.parking.lat ? 'üìç GPS Saved' : 'üì∏ Photo Saved'}</div>`; html += `<button class="btn btn-secondary btn-sm" style="margin-top:10px" onclick="APP.parking=null;saveStorage();renderParking()">üóëÔ∏è Clear</button>`; c.innerHTML = html; if (APP.parking.lat) { mc.style.display = 'block'; setTimeout(() => { if (APP.parkingMap) APP.parkingMap.remove(); APP.parkingMap = L.map('parkingMap', { zoomControl: false }).setView([APP.parking.lat, APP.parking.lon], 17); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(APP.parkingMap); L.marker([APP.parking.lat, APP.parking.lon]).addTo(APP.parkingMap); }, 100); } else mc.style.display = 'none'; }
        function saveCustomPlace() { const name = document.getElementById('customPlaceName').value.trim(); if (!name || !APP.parking?.lat) return showToast('Save GPS first', true); APP.customPlaces[name] = { lat: APP.parking.lat, lon: APP.parking.lon }; saveStorage(); document.getElementById('customPlaceName').value = ''; showToast('Place saved!'); renderPlaces(); }
        function renderPlaces() { const c = document.getElementById('customPlacesList'); c.innerHTML = Object.entries(APP.customPlaces).map(([n, d]) => `<div class="history-card" onclick="window.open('https://www.google.com/maps/dir/${d.lat},${d.lon}')"><div class="history-header"><span class="history-date">‚≠ê ${n}</span></div></div>`).join(''); }

        function addReminder(task, mins) { task = task || document.getElementById('reminderTask').value.trim(); mins = mins || parseInt(document.getElementById('reminderTime').value); if (!task) return showToast('Enter task', true); APP.reminders.push({ id: Date.now(), task, triggerTime: Date.now() + mins * 60000 }); saveStorage(); document.getElementById('reminderTask').value = ''; renderReminders(); showToast(`Reminder in ${mins}m`); return `OK, I will remind you to "${task}" in ${mins} minutes.`; }
        function renderReminders() { const active = APP.reminders.filter(r => r.triggerTime > Date.now()); document.getElementById('reminderBadge').textContent = active.length; document.getElementById('dashReminders').textContent = active.length; document.getElementById('reminderList').innerHTML = active.length ? active.map(r => `<div class="reminder-item"><div class="reminder-content"><div class="reminder-task">${r.task}</div><div class="reminder-time">${Math.ceil((r.triggerTime-Date.now())/60000)} min left</div></div><button class="reminder-delete" onclick="APP.reminders=APP.reminders.filter(x=>x.id!==${r.id});saveStorage();renderReminders()">‚úï</button></div>`).join('') : '<div style="text-align:center;color:var(--text-muted)">No reminders</div>'; }
        function checkReminders() { const now = Date.now(); APP.reminders.filter(r => r.triggerTime <= now).forEach(r => { showToast(`‚è∞ ${r.task}`, false, 8000); if (Notification.permission === 'granted') new Notification('Sunday', { body: r.task }); speakText(`Reminder: ${r.task}`); }); APP.reminders = APP.reminders.filter(r => r.triggerTime > now); saveStorage(); renderReminders(); }
        
        let news = []; async function loadNews() { try { news = (await (await fetch('https://api.rss2json.com/v1/api.json?rss_url=https://www.thestar.com.my/rss/news/nation')).json()).items?.slice(0, 5) || []; document.getElementById('dashNews').innerHTML = news.map(n => `<div class="search-item" onclick="window.open('${n.link}')">${n.title}</div>`).join(''); } catch(e) {} }

        // ‚úÖ NEW EXCHANGE RATE LOGIC WITH DATE PICKER
        let rates = {}; 
        async function loadCurrency(dateStr) { 
            const container = document.getElementById('currencyRates');
            container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            if (!dateStr) {
                const now = new Date();
                const offset = now.getTimezoneOffset() * 60000;
                dateStr = new Date(now.getTime() - offset).toISOString().split('T')[0];
                document.getElementById('currencyDate').value = dateStr;
            }

            const isToday = (new Date().toISOString().split('T')[0] === dateStr);
            let url = '';

            // Logic: Use ExchangeRate-API for Today (Latest), use Frankfurter for History
            if (isToday) {
                url = 'https://api.exchangerate-api.com/v4/latest/MYR';
            } else {
                url = `https://api.frankfurter.app/${dateStr}?from=MYR`;
            }

            try {
                const d = await (await fetch(url)).json();
                rates = d.rates;
                container.innerHTML = CURRENCIES.map(c => {
                     const rate = rates[c.code];
                     const val = rate ? (1/rate).toFixed(4) : 'N/A';
                     return `<div style="display:flex;justify-content:space-between;padding:8px;border-bottom:1px solid var(--glass-border)"><span>${c.flag} ${c.code}</span><span style="color:var(--accent-success)">${val}</span></div>`;
                }).join('');
            } catch(e) {
                container.innerHTML = '<div style="padding:10px;text-align:center;color:var(--accent-danger)">Data unavailable for this date (Market Closed?)</div>';
            }
        }

        // ================= AI CHAT LOGIC =================
        function addMsg(text, type) { const c = document.getElementById('chatMessages'); c.innerHTML += `<div class="chat-message ${type}"><div class="chat-bubble">${text}</div></div>`; c.scrollTop = c.scrollHeight; }
        
        async function sendChat() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if (!text) return;
            addMsg(text, 'user');
            input.value = '';
            
            const loadingId = 'loading-' + Date.now();
            const chatBox = document.getElementById('chatMessages');
            chatBox.innerHTML += `<div class="chat-message bot" id="${loadingId}"><div class="chat-bubble">Thinking... <span class="spinner" style="width:10px;height:10px;border-width:2px;display:inline-block"></span></div></div>`;
            chatBox.scrollTop = chatBox.scrollHeight;

            try {
                const localResult = await tryLocalCommand(text);
                const reply = localResult ? localResult : await callGeminiAI(text);
                document.getElementById(loadingId).remove();
                addMsg(reply, 'bot');
                speakText(reply);
            } catch (e) {
                document.getElementById(loadingId).remove();
                addMsg("‚ö†Ô∏è Error: " + e.message, 'bot');
            }
        }

        async function tryLocalCommand(t) {
            t = t.toLowerCase();
            if (t.startsWith('weather ') || t.includes('tianqi')) { const city = t.replace('weather', '').trim(); if(city) return await updateWeather(city, 0, 0); }
            const m = t.match(/remind.*?(\d+)\s*(min|hour|h|m).*?(?:to)?\s*(.+)/i);
            if (m) { let mins = parseInt(m[1]); if (m[2]?.startsWith('h')) mins *= 60; return addReminder(m[3], mins); }
            if (t.includes('car') || t.includes('parking')) { document.querySelector('[data-page="parking"]').click(); return APP.parking?.lat ? 'üöó Opening parking location...' : '‚ùå No parking location saved.'; }
            if (t.startsWith('rate ')) { const c = t.split(' ')[1].toUpperCase(); return rates[c] ? `üí± ${c}: ${(1/rates[c]).toFixed(4)} MYR` : 'Currency not found.'; }
            if (t.includes('news')) { return news[0]?.title ? `üì∞ Headline: ${news[0].title}` : 'No news available.'; }
            return null;
        }

        async function callGeminiAI(userText) {
            if (!GEMINI_API_KEY || GEMINI_API_KEY.length < 10) return "Please configure your Gemini API Key in the code.";
            const sysPrompt = `You are Sunday, a helpful AI assistant. Context: Time: ${new Date().toLocaleString()}, Weather: ${document.getElementById('weatherCondition').textContent}, ${document.getElementById('weatherTemp').textContent}¬∞C. Keep answers short and plain text.`;
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;
            const payload = { contents: [{ parts: [{ text: sysPrompt + "\nUser: " + userText }] }] };
            const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            const data = await response.json();
            if (data.candidates && data.candidates[0].content) { return data.candidates[0].content.parts[0].text.replace(/\*\*/g, '').replace(/\*/g, ''); } 
            else { return "I couldn't connect to the AI server."; }
        }

        // ================= VOICE & SPEECH =================
        function startListening() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) { return showToast("‚ö†Ô∏è Voice not supported", true); }
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            recognition.lang = 'en-US';
            recognition.interimResults = false;
            const input = document.getElementById('chatInput');
            input.placeholder = "Listening...";
            recognition.start();
            recognition.onresult = (event) => { const transcript = event.results[0][0].transcript; input.value = transcript; input.placeholder = "Type..."; setTimeout(sendChat, 500); };
            recognition.onerror = () => { input.placeholder = "Type..."; };
            recognition.onend = () => { input.placeholder = "Type..."; };
        }

        function speakText(text) {
            if (!window.speechSynthesis) return;
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US';
            utterance.rate = 1.1;
            window.speechSynthesis.speak(utterance);
        }

        function showToast(msg, err = false, dur = 3000) { const t = document.getElementById('toast'); t.querySelector('.toast-icon').textContent = err ? '‚ùå' : '‚úÖ'; t.querySelector('.toast-message').textContent = msg; t.classList.toggle('error', err); t.classList.add('show'); setTimeout(() => t.classList.remove('show'), dur); }
        function closeModal() { document.getElementById('historyModal').classList.remove('show'); }
    </script>
</body>
</html>
